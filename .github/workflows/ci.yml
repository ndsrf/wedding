name: CI

on:
  pull_request:
    branches:
      - main
      - develop

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Lint and Type Check (runs in parallel)
  # ============================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      - name: Run ESLint
        run: npm run lint

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      - name: Run TypeScript type check
        run: npm run type-check

  # ============================================
  # Unit Tests
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      - name: Run unit tests
        run: npm run test:unit
        env:
          CI: true

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        if: always()
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN || '' }}
          files: ./coverage/lcov.info
          flags: unit-tests
          fail_ci_if_error: false

  # ============================================
  # Integration Tests
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: wedding_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/wedding_test

      - name: Generate Prisma client
        run: npx prisma generate
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/wedding_test

      - name: Run database migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/wedding_test

      - name: Run integration tests
        run: npm run test:integration
        env:
          CI: true
          DATABASE_URL: postgresql://test:test@localhost:5432/wedding_test
          NEXTAUTH_SECRET: test-secret-for-ci
          NEXTAUTH_URL: http://localhost:3000

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        if: always()
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN || '' }}
          files: ./coverage/lcov.info
          flags: integration-tests
          fail_ci_if_error: false

  # ============================================
  # Build Check
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, type-check]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Create .env file for build
        run: |
          echo "DATABASE_URL=postgresql://dummy:dummy@localhost:5432/dummy" > .env
          echo "✓ Created .env file for build"
          cat .env

      - name: Install dependencies
        run: npm ci
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      - name: Generate Prisma client
        run: |
          echo "=== Generating Prisma Client ==="
          npx prisma generate
          echo "=== Prisma generate completed ==="
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      - name: Verify Prisma client generated
        run: |
          echo "=== Checking for Prisma client ==="
          if [ -d "node_modules/.prisma/client" ]; then
            echo "✓ Prisma client found"
            ls -la node_modules/.prisma/client | head -10
          else
            echo "✗ Prisma client NOT found"
            echo "=== node_modules structure ==="
            ls -la node_modules/.prisma 2>/dev/null || echo "No .prisma directory"
            ls -la node_modules | grep prisma || echo "No prisma packages found"
            exit 1
          fi

      - name: Pre-build diagnostics
        run: |
          echo "=== Node version ==="
          node --version
          echo ""
          echo "=== npm version ==="
          npm --version
          echo ""
          echo "=== Environment variables ==="
          echo "DATABASE_URL: ${DATABASE_URL:0:20}..." || echo "DATABASE_URL not set"
          echo "NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:0:10}..." || echo "NEXTAUTH_SECRET not set"
          echo ""
          echo "=== Checking for required files ==="
          [ -f "next.config.js" ] && echo "✓ next.config.js found" || echo "✗ next.config.js NOT found"
          [ -f "tsconfig.json" ] && echo "✓ tsconfig.json found" || echo "✗ tsconfig.json NOT found"
          [ -f "package.json" ] && echo "✓ package.json found" || echo "✗ package.json NOT found"
          [ -d "src" ] && echo "✓ src directory found" || echo "✗ src directory NOT found"
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
          NEXTAUTH_SECRET: dummy-secret-for-build
          NEXTAUTH_URL: http://localhost:3000
          NEXT_PUBLIC_IS_E2E: 'true'

      - name: Build application
        run: |
          echo "=== Starting Next.js build ==="
          npm run build 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          echo "=== Build exit code: $BUILD_EXIT_CODE ==="
          exit $BUILD_EXIT_CODE
        env:
          # Provide dummy env vars for build
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
          NEXTAUTH_SECRET: dummy-secret-for-build
          NEXTAUTH_URL: http://localhost:3000
          NEXT_PUBLIC_IS_E2E: 'true'
        continue-on-error: true

      - name: Check build logs for errors
        if: always()
        run: |
          echo "=== Build Log (Last 100 lines) ==="
          tail -100 build.log || echo "No build.log found"
          echo ""
          echo "=== Searching for errors in build log ==="
          if grep -i "error\|fatal\|failed" build.log > /dev/null 2>&1; then
            echo "ERRORS FOUND:"
            grep -i "error\|fatal\|failed" build.log | head -20
          else
            echo "No obvious errors found in build log"
          fi

      - name: Verify and prepare build output
        if: always()
        run: |
          echo "=== Checking build directory structure ==="
          ls -lah
          echo ""
          echo "=== Checking if .next exists ==="
          if [ -d ".next" ]; then
            echo "✓ .next directory found"
            echo "Size before cleanup: $(du -sh .next | cut -f1)"
            echo ""
            echo "Removing cache and standalone dirs to reduce artifact size..."
            rm -rf .next/cache .next/standalone
            echo "Size after cleanup: $(du -sh .next | cut -f1)"
            echo ""
            echo "Creating tar archive for upload..."
            tar -czf .next-build.tar.gz .next/
            echo "Archive size: $(du -sh .next-build.tar.gz | cut -f1)"
            echo ""
            echo "Contents of .next directory:"
            ls -la .next | head -20
            exit 0
          else
            echo "✗ .next directory NOT found"
            echo ""
            echo "=== Available directories ==="
            find . -maxdepth 1 -type d -ls
            echo ""
            echo "=== Checking for alternative output directories ==="
            find . -maxdepth 2 -name ".next*" -o -name "out" -o -name "dist" 2>/dev/null || echo "None found"
            echo ""
            echo "=== Full build log (if available) ==="
            [ -f build.log ] && tail -200 build.log || echo "No build.log found"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: build-output
          path: .next-build.tar.gz
          retention-days: 5
          if-no-files-found: error

  # ============================================
  # E2E Tests (optional, runs on main only)
  # ============================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: wedding_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/wedding_test

      - name: List available artifacts
        if: always()
        run: |
          echo "=== Checking for available artifacts ==="
          echo "Expected artifact: build-output"
          echo ""
          echo "Note: If no artifacts are listed below, the build job may have failed or not uploaded artifacts"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Extract and verify build artifacts
        run: |
          echo "=== Extracting build artifacts ==="
          if [ ! -f ".next-build.tar.gz" ]; then
            echo "ERROR: .next-build.tar.gz not found"
            ls -la
            exit 1
          fi
          tar -xzf .next-build.tar.gz
          echo "✓ Build artifacts extracted"
          echo "Size: $(du -sh .next | cut -f1)"
          echo ""
          echo "Verifying .next directory structure:"
          ls -la .next | head -10

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Generate Prisma client
        run: npx prisma generate
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/wedding_test

      - name: Run database migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/wedding_test

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          CI: true
          DATABASE_URL: postgresql://test:test@localhost:5432/wedding_test
          NEXTAUTH_SECRET: test-secret-for-ci
          NEXTAUTH_URL: http://localhost:3000
          NEXT_PUBLIC_IS_E2E: 'true'

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report
          retention-days: 7

  # ============================================
  # Security Audit
  # ============================================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

  # ============================================
  # CI Summary
  # ============================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, type-check, unit-tests, integration-tests, build]
    if: always()
    steps:
      - name: Check CI status
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.type-check.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "CI failed: lint=${{ needs.lint.result }}, type-check=${{ needs.type-check.result }}, build=${{ needs.build.result }}"
            exit 1
          fi
          echo "CI passed successfully!"
