generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model MasterAdmin {
  id                 String   @id @default(uuid())
  email              String   @unique
  name               String
  preferred_language Language @default(EN)
  created_at         DateTime @default(now())

  @@map("master_admins")
}

model WeddingPlanner {
  id                  String                     @id @default(uuid())
  email               String                     @unique
  name                String
  google_id           String?                    @unique
  auth_provider       AuthProvider
  last_login_provider AuthProvider?
  preferred_language  Language                   @default(EN)
  logo_url            String?
  enabled             Boolean                    @default(true)
  subscription_status SubscriptionStatus         @default(ACTIVE)
  created_at          DateTime                   @default(now())
  created_by          String
  last_login_at       DateTime?
  checklist_template  ChecklistTemplate?
  themes              Theme[]
  weddings            Wedding[]
  provider_categories ProviderCategory[]
  providers           Provider[]
  message_templates   PlannerMessageTemplate[]
  locations           Location[]

  @@index([enabled])
  @@map("wedding_planners")
}

model Theme {
  id                String          @id @default(uuid())
  planner_id        String?
  name              String
  description       String
  is_default        Boolean         @default(false)
  is_system_theme   Boolean         @default(false)
  config            Json
  preview_image_url String?
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt
  planner           WeddingPlanner? @relation(fields: [planner_id], references: [id])
  weddings          Wedding[]

  @@index([planner_id])
  @@index([is_system_theme])
  @@map("themes")
}

model Wedding {
  id                              String             @id @default(uuid())
  planner_id                      String
  theme_id                        String?
  invitation_template_id          String?
  couple_names                    String
  wedding_date                    DateTime
  wedding_time                    String
  location                        String?
  main_event_location_id          String?
  rsvp_cutoff_date                DateTime
  dress_code                      String?
  additional_info                 String?
  payment_tracking_mode           PaymentMode        @default(MANUAL)
  allow_guest_additions           Boolean            @default(true)
  default_language                Language           @default(ES)
  wedding_country                 String             @default("ES")
  status                          WeddingStatus      @default(ACTIVE)
  created_at                      DateTime           @default(now())
  created_by                      String
  updated_at                      DateTime           @updatedAt
  updated_by                      String?
  transportation_question_enabled Boolean            @default(false)
  transportation_question_text    String?
  dietary_restrictions_enabled    Boolean            @default(false)
  save_the_date_enabled           Boolean            @default(false)
  whatsapp_mode                   WhatsAppMode       @default(BUSINESS)
  short_url_initials              String?            @unique
  extra_question_1_enabled        Boolean            @default(false)
  extra_question_1_text           String?
  extra_question_2_enabled        Boolean            @default(false)
  extra_question_2_text           String?
  extra_question_3_enabled        Boolean            @default(false)
  extra_question_3_text           String?
  extra_info_1_enabled            Boolean            @default(false)
  extra_info_1_label              String?
  extra_info_2_enabled            Boolean            @default(false)
  extra_info_2_label              String?
  extra_info_3_enabled            Boolean            @default(false)
  extra_info_3_label              String?
  deleted_at                      DateTime?
  deleted_by                      String?
  disabled_at                     DateTime?
  disabled_by                     String?
  is_disabled                     Boolean            @default(false)
  gift_iban                       String?
  couple_table_id                 String?
  checklist_sections              ChecklistSection[]
  checklist_tasks                 ChecklistTask[]
  families                        Family[]
  message_templates               MessageTemplate[]
  invitation_templates            InvitationTemplate[]
  notifications                   Notification[]
  tables                          Table[]
  tracking_events                 TrackingEvent[]
  wedding_admins                  WeddingAdmin[]
  providers                       WeddingProvider[]
  itinerary_items                 ItineraryItem[]
  planner                         WeddingPlanner     @relation(fields: [planner_id], references: [id], onDelete: Cascade)
  theme                           Theme?             @relation(fields: [theme_id], references: [id])
  main_event_location             Location?          @relation("MainEventLocation", fields: [main_event_location_id], references: [id], onDelete: SetNull)

  @@index([planner_id])
  @@index([theme_id])
  @@index([status])
  @@index([wedding_date])
  @@index([is_disabled])
  @@index([status, is_disabled])
  @@index([main_event_location_id])
  @@map("weddings")
}

model WeddingAdmin {
  id                  String        @id @default(uuid())
  email               String
  name                String
  google_id           String?
  auth_provider       AuthProvider
  last_login_provider AuthProvider?
  preferred_language  Language      @default(EN)
  wedding_id          String
  invited_by          String
  invited_at          DateTime      @default(now())
  accepted_at         DateTime?
  last_login_at       DateTime?
  created_at          DateTime      @default(now())
  wedding             Wedding       @relation(fields: [wedding_id], references: [id], onDelete: Cascade)

  @@unique([email, wedding_id])
  @@index([wedding_id])
  @@index([email])
  @@map("wedding_admins")
}

model Location {
  id                  String          @id @default(uuid())
  planner_id          String
  name                String
  location_type       LocationType
  url                 String?
  notes               String?         @db.Text
  google_maps_url     String?
  address             String?
  created_at          DateTime        @default(now())
  updated_at          DateTime        @updatedAt
  planner             WeddingPlanner  @relation(fields: [planner_id], references: [id], onDelete: Cascade)
  weddings            Wedding[]       @relation("MainEventLocation")
  itinerary_items     ItineraryItem[]

  @@index([planner_id])
  @@index([location_type])
  @@map("locations")
}

model ItineraryItem {
  id          String    @id @default(uuid())
  wedding_id  String
  location_id String
  date_time   DateTime
  notes       String?   @db.Text
  order       Int
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  wedding     Wedding   @relation(fields: [wedding_id], references: [id], onDelete: Cascade)
  location    Location  @relation(fields: [location_id], references: [id], onDelete: Restrict)

  @@index([wedding_id])
  @@index([location_id])
  @@index([wedding_id, order])
  @@map("itinerary_items")
}

model MessageTemplate {
  id                 String       @id @default(uuid())
  wedding_id         String
  type               TemplateType
  language           Language
  channel            Channel
  subject            String
  body               String
  image_url          String?
  content_template_id String?      // Twilio Content Template SID for WhatsApp
  created_at         DateTime     @default(now())
  updated_at         DateTime     @updatedAt
  wedding            Wedding      @relation(fields: [wedding_id], references: [id], onDelete: Cascade)

  @@unique([wedding_id, type, language, channel])
  @@index([wedding_id])
  @@index([type])
  @@map("message_templates")
}

model PlannerMessageTemplate {
  id                 String          @id @default(uuid())
  planner_id         String
  type               TemplateType
  language           Language
  channel            Channel
  subject            String
  body               String
  image_url          String?
  content_template_id String?        // Twilio Content Template SID for WhatsApp
  created_at         DateTime        @default(now())
  updated_at         DateTime        @updatedAt
  planner            WeddingPlanner  @relation(fields: [planner_id], references: [id], onDelete: Cascade)

  @@unique([planner_id, type, language, channel])
  @@index([planner_id])
  @@index([type])
  @@map("planner_message_templates")
}

model MasterMessageTemplate {
  id                 String       @id @default(uuid())
  type               TemplateType
  language           Language
  channel            Channel
  subject            String
  body               String
  created_at         DateTime     @default(now())
  updated_at         DateTime     @updatedAt

  @@unique([type, language, channel])
  @@index([type])
  @@map("master_message_templates")
}

model InvitationTemplate {
  id                  String   @id @default(uuid())
  wedding_id          String
  name                String
  is_system_template  Boolean  @default(false)
  based_on_preset     String?  // ThemePreset id if forked from a system seed; null if blank
  design              Json     // TemplateDesign
  pre_rendered_html   Json?    // Pre-rendered HTML for each language: { ES: "...", EN: "...", ... }
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt
  wedding             Wedding  @relation(fields: [wedding_id], references: [id], onDelete: Cascade)

  @@index([wedding_id])
  @@map("invitation_templates")
}

model Family {
  id                      String          @id @default(uuid())
  wedding_id              String
  name                    String
  email                   String?
  phone                   String?
  whatsapp_number         String?
  magic_token             String          @unique @default(uuid())
  short_url_code          String?
  reference_code          String?         @unique
  channel_preference      Channel?
  preferred_language      Language        @default(ES)
  invited_by_admin_id     String?
  private_notes           String?         @db.Text
  save_the_date_sent      DateTime?
  created_at              DateTime        @default(now())
  extra_info_1_value      String?
  extra_info_2_value      String?
  extra_info_3_value      String?
  extra_question_1_answer Boolean?
  extra_question_2_answer Boolean?
  extra_question_3_answer Boolean?
  transportation_answer   Boolean?
  wedding                 Wedding         @relation(fields: [wedding_id], references: [id], onDelete: Cascade)
  members                 FamilyMember[]
  gifts                   Gift[]
  notifications           Notification[]
  tracking_events         TrackingEvent[]

  @@unique([wedding_id, short_url_code])
  @@index([wedding_id])
  @@index([magic_token])
  @@index([reference_code])
  @@index([email])
  @@map("families")
}

model FamilyMember {
  id                   String     @id @default(uuid())
  family_id            String
  name                 String
  type                 MemberType
  attending            Boolean?
  age                  Int?
  dietary_restrictions String?
  accessibility_needs  String?
  added_by_guest       Boolean    @default(false)
  table_id             String?
  seating_group        String?
  created_at           DateTime   @default(now())
  family               Family     @relation(fields: [family_id], references: [id], onDelete: Cascade)
  table                Table?     @relation(fields: [table_id], references: [id], onDelete: SetNull)

  @@index([family_id])
  @@index([table_id])
  @@index([added_by_guest])
  @@map("family_members")
}

// ============================================================================
// TRACKING & NOTIFICATIONS
// ============================================================================

model TrackingEvent {
  id              String         @id @default(uuid())
  family_id       String
  wedding_id      String
  event_type      EventType
  channel         Channel?
  metadata        Json?
  admin_triggered Boolean        @default(false)
  timestamp       DateTime       @default(now())
  family          Family         @relation(fields: [family_id], references: [id], onDelete: Cascade)
  wedding         Wedding        @relation(fields: [wedding_id], references: [id], onDelete: Cascade)
  notifications   Notification[]

  @@index([family_id])
  @@index([wedding_id])
  @@index([event_type])
  @@index([timestamp])
  @@map("tracking_events")
}

model Notification {
  id                String         @id @default(uuid())
  wedding_id        String
  family_id         String?
  tracking_event_id String?
  event_type        EventType
  channel           Channel?
  details           Json
  read              Boolean        @default(false)
  read_at           DateTime?
  admin_id          String
  created_at        DateTime       @default(now())
  family            Family?        @relation(fields: [family_id], references: [id], onDelete: Cascade)
  wedding           Wedding        @relation(fields: [wedding_id], references: [id], onDelete: Cascade)
  tracking_event    TrackingEvent? @relation(fields: [tracking_event_id], references: [id], onDelete: Cascade)

  @@index([wedding_id])
  @@index([admin_id])
  @@index([read])
  @@index([created_at])
  @@index([tracking_event_id])
  @@map("notifications")
}

model Gift {
  id                  String     @id @default(uuid())
  family_id           String
  wedding_id          String
  amount              Decimal    @db.Decimal(10, 2)
  reference_code_used String?
  auto_matched        Boolean    @default(false)
  status              GiftStatus @default(PENDING)
  transaction_date    DateTime
  created_at          DateTime   @default(now())
  family              Family     @relation(fields: [family_id], references: [id], onDelete: Cascade)

  @@index([family_id])
  @@index([wedding_id])
  @@index([status])
  @@index([reference_code_used])
  @@map("gifts")
}

model Translation {
  id         String             @id @default(uuid())
  key        String
  language   Language
  value      String
  context    TranslationContext
  updated_at DateTime           @updatedAt

  @@unique([key, language])
  @@index([context])
  @@index([language])
  @@map("translations")
}

// -----------------------------------------------------------------------------
// SEATING (ai-gemini) — Table management
// -----------------------------------------------------------------------------

model Table {
  id              String         @id @default(uuid())
  wedding_id      String
  name            String?
  number          Int
  capacity        Int
  created_at      DateTime       @default(now())
  updated_at      DateTime       @updatedAt
  assigned_guests FamilyMember[]
  wedding         Wedding        @relation(fields: [wedding_id], references: [id], onDelete: Cascade)

  @@unique([wedding_id, number])
  @@index([wedding_id])
  @@map("tables")
}

// -----------------------------------------------------------------------------
// CHECKLIST (main) — Template, sections, tasks
// -----------------------------------------------------------------------------

model ChecklistTemplate {
  id         String               @id @default(uuid())
  planner_id String               @unique
  created_at DateTime             @default(now())
  updated_at DateTime             @updatedAt
  sections   ChecklistSection[]
  tasks      ChecklistTask[]
  planner    WeddingPlanner       @relation(fields: [planner_id], references: [id], onDelete: Cascade)

  @@index([planner_id])
  @@map("checklist_templates")
}

model ChecklistSection {
  id          String               @id @default(uuid())
  template_id String?
  wedding_id  String?
  name        String
  order       Int
  created_at  DateTime             @default(now())
  template    ChecklistTemplate?   @relation(fields: [template_id], references: [id], onDelete: Cascade)
  wedding     Wedding?             @relation(fields: [wedding_id], references: [id], onDelete: Cascade)
  tasks       ChecklistTask[]

  @@index([template_id])
  @@index([wedding_id])
  @@index([order])
  @@map("checklist_sections")
}

model ChecklistTask {
  id                String               @id @default(uuid())
  section_id        String?
  wedding_id        String?
  template_id       String?
  title             String
  description       String?              @db.Text
  assigned_to       TaskAssignment       @default(COUPLE)
  due_date          DateTime?
  due_date_relative String?
  status            TaskStatus           @default(PENDING)
  completed         Boolean              @default(false)
  completed_at      DateTime?
  completed_by      String?
  order             Int
  created_at        DateTime             @default(now())
  updated_at        DateTime             @updatedAt
  section           ChecklistSection?    @relation(fields: [section_id], references: [id], onDelete: Cascade)
  wedding           Wedding?             @relation(fields: [wedding_id], references: [id], onDelete: Cascade)
  template          ChecklistTemplate?   @relation(fields: [template_id], references: [id], onDelete: Cascade)

  @@index([section_id])
  @@index([wedding_id])
  @@index([template_id])
  @@index([assigned_to])
  @@index([due_date])
  @@index([status])
  @@index([completed])
  @@index([order])
  @@map("checklist_tasks")
}

// -----------------------------------------------------------------------------
// PROVIDERS & PAYMENTS
// -----------------------------------------------------------------------------

model ProviderCategory {
  id          String         @id @default(uuid())
  planner_id  String
  name        String
  created_at  DateTime       @default(now())
  updated_at  DateTime       @updatedAt
  planner     WeddingPlanner @relation(fields: [planner_id], references: [id], onDelete: Cascade)
  providers   Provider[]
  wedding_providers WeddingProvider[]

  @@unique([planner_id, name])
  @@index([planner_id])
  @@map("provider_categories")
}

model Provider {
  id              String            @id @default(uuid())
  planner_id      String
  category_id     String
  name            String
  contact_name    String?
  email           String?
  phone           String?
  website         String?
  social_media    String?
  approx_price    Decimal?          @db.Decimal(10, 2)
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt
  planner         WeddingPlanner    @relation(fields: [planner_id], references: [id], onDelete: Cascade)
  category        ProviderCategory  @relation(fields: [category_id], references: [id], onDelete: Cascade)
  wedding_assignments WeddingProvider[]

  @@index([planner_id])
  @@index([category_id])
  @@map("providers")
}

model WeddingProvider {
  id              String    @id @default(uuid())
  wedding_id      String
  category_id     String
  provider_id     String?
  name            String?
  contact_name    String?
  email           String?
  phone           String?
  website         String?
  social_media    String?
  total_price     Decimal?  @db.Decimal(10, 2)
  contract_url    String?
  notes           String?   @db.Text
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  wedding         Wedding   @relation(fields: [wedding_id], references: [id], onDelete: Cascade)
  category        ProviderCategory @relation(fields: [category_id], references: [id], onDelete: Restrict)
  provider        Provider? @relation(fields: [provider_id], references: [id], onDelete: Restrict)
  payments        Payment[]

  @@unique([wedding_id, category_id, provider_id])
  @@index([wedding_id])
  @@index([category_id])
  @@index([provider_id])
  @@map("wedding_providers")
}

model Payment {
  id                  String          @id @default(uuid())
  wedding_provider_id String
  amount              Decimal         @db.Decimal(10, 2)
  date                DateTime        @default(now())
  method              PaymentMethod
  notes               String?         @db.Text
  document_url        String?
  created_at          DateTime        @default(now())
  updated_at          DateTime        @updatedAt
  wedding_provider    WeddingProvider @relation(fields: [wedding_provider_id], references: [id], onDelete: Cascade)

  @@index([wedding_provider_id])
  @@map("payments")
}

// -----------------------------------------------------------------------------
// Enums
// -----------------------------------------------------------------------------

enum Language {
  ES
  EN
  FR
  IT
  DE
}

enum AuthProvider {
  GOOGLE
  FACEBOOK
  INSTAGRAM
  MICROSOFT
}

enum PaymentMode {
  AUTOMATED
  MANUAL
}

enum WeddingStatus {
  ACTIVE
  ARCHIVED
  COMPLETED
  DELETED
}

enum MemberType {
  ADULT
  CHILD
  INFANT
}

enum EventType {
  LINK_OPENED
  RSVP_STARTED
  RSVP_SUBMITTED
  RSVP_UPDATED
  GUEST_ADDED
  PAYMENT_RECEIVED
  REMINDER_SENT
  INVITATION_SENT
  SAVE_THE_DATE_SENT
  TASK_ASSIGNED
  TASK_COMPLETED
  MESSAGE_DELIVERED
  MESSAGE_READ
  MESSAGE_FAILED
}

enum TemplateType {
  SAVE_THE_DATE
  INVITATION
  REMINDER
  CONFIRMATION
}

enum Channel {
  WHATSAPP
  EMAIL
  SMS
}

enum GiftStatus {
  PENDING
  RECEIVED
  CONFIRMED
}

enum TranslationContext {
  ADMIN
  GUEST
  PLANNER
  MASTER
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
}

enum TaskAssignment {
  WEDDING_PLANNER
  COUPLE
  OTHER
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  PAYPAL
  BIZUM
  REVOLUT
  OTHER
}

enum WhatsAppMode {
  BUSINESS
  LINKS
}

enum LocationType {
  CEREMONY
  EVENT
  PRE_EVENT
  POST_EVENT
}