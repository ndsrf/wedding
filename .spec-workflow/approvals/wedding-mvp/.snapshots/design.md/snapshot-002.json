{
  "id": "snapshot_1768301105322_662vh7u4l",
  "approvalId": "approval_1768300405078_9k8rkeuyl",
  "approvalTitle": "Design Document - Wedding App MVP",
  "version": 2,
  "timestamp": "2026-01-13T10:45:05.322Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: Wedding Management App MVP\n\n## Overview\n\nThe Wedding Management App is a multi-tenant SaaS platform built with a modern TypeScript stack. The system provides three distinct user interfaces: a master admin panel for platform management, a wedding planner dashboard for managing multiple weddings, wedding admin panels for couples to manage their specific wedding, and a guest-facing RSVP system accessible via persistent magic links.\n\nThe architecture emphasizes **data isolation** through multi-tenancy, **modular design** with clear separation of concerns, and **mobile-first** responsive interfaces optimized for WhatsApp in-app browsers.\n\n## Steering Document Alignment\n\n### Technical Standards\n\nSince this is a new project without existing steering documents, this design establishes the following technical standards:\n\n- **Language**: TypeScript for type safety across frontend and backend\n- **Backend Framework**: Next.js 14+ with App Router for API routes and server-side rendering\n- **Database**: PostgreSQL 15+ with Prisma ORM for type-safe database access\n- **Authentication**: NextAuth.js for OAuth providers, custom magic link implementation\n- **Internationalization**: next-intl for translations with JSON files and database storage\n- **UI Framework**: React 18+ with Tailwind CSS for mobile-first responsive design\n- **Email**: Resend for transactional emails\n- **Testing**: Jest for unit tests, Playwright for E2E tests\n\n### Project Structure\n\n```\nwedding/\n├── src/\n│   ├── app/                      # Next.js App Router\n│   │   ├── api/                  # API routes\n│   │   │   ├── auth/             # NextAuth.js handlers\n│   │   │   ├── master/           # Master admin APIs\n│   │   │   ├── planner/          # Wedding planner APIs\n│   │   │   ├── admin/            # Wedding admin APIs\n│   │   │   └── guest/            # Guest RSVP APIs\n│   │   ├── master/               # Master admin UI\n│   │   ├── planner/              # Planner dashboard UI\n│   │   ├── admin/                # Wedding admin UI\n│   │   ├── rsvp/                 # Guest RSVP pages\n│   │   └── layout.tsx            # Root layout\n│   ├── components/               # Shared React components\n│   │   ├── ui/                   # Base UI components (buttons, inputs, etc.)\n│   │   ├── master/               # Master admin components\n│   │   ├── planner/              # Planner components\n│   │   ├── admin/                # Wedding admin components\n│   │   └── guest/                # Guest RSVP components\n│   ├── lib/                      # Shared utilities and services\n│   │   ├── db/                   # Database client and utilities\n│   │   │   └── prisma.ts         # Prisma client singleton\n│   │   ├── auth/                 # Authentication utilities\n│   │   │   ├── oauth.ts          # OAuth provider configs\n│   │   │   ├── magic-link.ts     # Magic link generation/validation\n│   │   │   └── middleware.ts     # Auth middleware\n│   │   ├── i18n/                 # Internationalization\n│   │   │   ├── config.ts         # i18n configuration\n│   │   │   ├── server.ts         # Server-side translation\n│   │   │   └── client.ts         # Client-side translation\n│   │   ├── excel/                # Excel import/export\n│   │   │   ├── import.ts         # Guest list import\n│   │   │   ├── export.ts         # Data export\n│   │   │   └── templates.ts      # Template generation\n│   │   ├── email/                # Email service\n│   │   │   ├── resend.ts         # Resend client\n│   │   │   └── templates/        # Email templates\n│   │   ├── tracking/             # Event tracking\n│   │   │   └── events.ts         # Tracking event service\n│   │   ├── payment/              # Payment integration\n│   │   │   ├── gocardless.ts     # GoCardless API client\n│   │   │   └── matching.ts       # Payment matching logic\n│   │   └── theme/                # Theme system\n│   │       ├── engine.ts         # Theme rendering engine\n│   │       └── presets.ts        # Pre-built themes\n│   ├── types/                    # TypeScript type definitions\n│   │   ├── models.ts             # Database model types\n│   │   ├── api.ts                # API request/response types\n│   │   └── theme.ts              # Theme configuration types\n│   └── middleware.ts             # Next.js middleware (auth, i18n)\n├── prisma/\n│   ├── schema.prisma             # Database schema\n│   ├── migrations/               # Migration files\n│   └── seed.ts                   # Database seeding\n├── public/\n│   └── locales/                  # Static translations\n│       ├── es/                   # Spanish\n│       ├── en/                   # English\n│       ├── fr/                   # French\n│       ├── it/                   # Italian\n│       └── de/                   # German\n├── config/\n│   └── master-admin.json         # Master admin configuration\n└── tests/\n    ├── unit/                     # Unit tests\n    ├── integration/              # Integration tests\n    └── e2e/                      # End-to-end tests\n```\n\n## Code Reuse Analysis\n\nSince this is a new project, there is no existing code to reuse. However, the design emphasizes creating reusable modules from the start:\n\n### Planned Reusable Components\n\n- **Authentication Module** (`lib/auth/`): Will be used by all three admin types (master, planner, wedding admin)\n- **Database Client** (`lib/db/prisma.ts`): Singleton pattern, shared across all API routes\n- **Tracking Service** (`lib/tracking/events.ts`): Used by guest RSVP flows and admin manual actions\n- **Theme Engine** (`lib/theme/engine.ts`): Applied to all guest-facing pages\n- **i18n Utilities** (`lib/i18n/`): Used in all UI components and API responses\n\n### Integration Points\n\n- **NextAuth.js**: Handles OAuth flows for Google, Facebook/Instagram, Apple\n- **Prisma ORM**: Type-safe database access with automatic TypeScript types\n- **Next.js Middleware**: Intercepts requests for authentication and language detection\n- **Resend API**: Sends invitation emails, reminders, and confirmations\n- **GoCardless Bank Account Data API**: Polls bank transactions for payment matching (optional for automated mode)\n\n## Architecture\n\n### System Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Client Layer\"\n        MA[Master Admin UI]\n        PD[Planner Dashboard]\n        WA[Wedding Admin Panel]\n        GR[Guest RSVP Pages]\n    end\n\n    subgraph \"Next.js Application\"\n        MW[Middleware: Auth + i18n]\n\n        subgraph \"API Routes\"\n            MA_API[Master Admin API]\n            PL_API[Planner API]\n            WA_API[Wedding Admin API]\n            GU_API[Guest API]\n        end\n\n        subgraph \"Service Layer\"\n            AUTH[Auth Service]\n            TRACK[Tracking Service]\n            EMAIL[Email Service]\n            EXCEL[Excel Service]\n            PAY[Payment Service]\n            THEME[Theme Service]\n        end\n    end\n\n    subgraph \"Data Layer\"\n        DB[(PostgreSQL)]\n        CACHE[Redis Cache]\n    end\n\n    subgraph \"External Services\"\n        OAUTH[OAuth Providers]\n        RESEND[Resend Email]\n        GC[GoCardless API]\n    end\n\n    MA --> MW\n    PD --> MW\n    WA --> MW\n    GR --> MW\n\n    MW --> MA_API\n    MW --> PL_API\n    MW --> WA_API\n    MW --> GU_API\n\n    MA_API --> AUTH\n    PL_API --> AUTH\n    WA_API --> AUTH\n    GU_API --> AUTH\n\n    MA_API --> DB\n    PL_API --> DB\n    WA_API --> DB\n    GU_API --> DB\n\n    AUTH --> OAUTH\n    AUTH --> DB\n\n    TRACK --> DB\n    EMAIL --> RESEND\n    EXCEL --> DB\n    PAY --> GC\n    PAY --> DB\n    THEME --> CACHE\n\n    WA_API --> TRACK\n    GU_API --> TRACK\n    WA_API --> EMAIL\n    WA_API --> EXCEL\n    WA_API --> PAY\n    GU_API --> THEME\n```\n\n### Multi-Tenancy Design\n\n**Data Isolation Strategy**: All queries must include `wedding_id` filtering to ensure complete data separation.\n\n**Implementation**:\n1. **Prisma Middleware**: Inject `wedding_id` filter into all queries automatically\n2. **API Context**: Extract `wedding_id` from authenticated user session\n3. **Validation**: Verify user has access to the requested wedding before any operation\n\n**Example**:\n```typescript\n// Prisma middleware for automatic wedding_id filtering\nprisma.$use(async (params, next) => {\n  if (params.model === 'Family' && params.action === 'findMany') {\n    params.args.where = {\n      ...params.args.where,\n      wedding_id: getCurrentWeddingId()\n    }\n  }\n  return next(params)\n})\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: Each service file handles one domain (auth, tracking, email, etc.)\n- **Component Isolation**: UI components are small, focused, and reusable (button, form, card, etc.)\n- **Service Layer Separation**: Business logic separated from API routes and database access\n- **Utility Modularity**: Helper functions grouped by purpose (date formatting, string manipulation, validation)\n\n## Components and Interfaces\n\n### 1. Authentication Service (`lib/auth/`)\n\n**Purpose**: Handles OAuth authentication for admins and magic link generation/validation for guests\n\n**Modules**:\n- `oauth.ts`: NextAuth.js configuration with Google, Facebook, Apple providers\n- `magic-link.ts`: Generate secure UUIDs, validate tokens, track expiry\n- `middleware.ts`: Protect routes, extract user context\n\n**Interfaces**:\n```typescript\n// OAuth user after authentication\ninterface AuthenticatedUser {\n  id: string\n  email: string\n  name: string\n  role: 'master_admin' | 'planner' | 'wedding_admin'\n  wedding_id?: string // null for master admin and planners\n  planner_id?: string // null for master admin\n  preferred_language: Language\n  last_login_provider: OAuthProvider\n}\n\n// Magic link generation\nfunction generateMagicLink(family_id: string): Promise<MagicLink>\nfunction validateMagicLink(token: string): Promise<Family | null>\n\n// Middleware\nfunction requireAuth(role: UserRole): NextMiddleware\nfunction extractUserContext(req: NextRequest): Promise<AuthenticatedUser>\n```\n\n**Dependencies**: NextAuth.js, Prisma, crypto\n\n**Reuses**: Prisma client for database access\n\n### 2. Database Service (`lib/db/`)\n\n**Purpose**: Provides type-safe database access with multi-tenancy support\n\n**Modules**:\n- `prisma.ts`: Singleton Prisma client with connection pooling\n- `middleware.ts`: Automatic wedding_id filtering\n\n**Interfaces**:\n```typescript\n// Singleton pattern\nfunction getPrismaClient(): PrismaClient\n\n// Multi-tenant context\ninterface TenantContext {\n  wedding_id: string\n  user_id: string\n  user_role: UserRole\n}\n\n// Scoped client with automatic filtering\nfunction getScopedClient(context: TenantContext): PrismaClient\n```\n\n**Dependencies**: Prisma, PostgreSQL\n\n### 3. Tracking Service (`lib/tracking/events.ts`)\n\n**Purpose**: Log all guest interactions and admin actions for analytics and notifications\n\n**Interfaces**:\n```typescript\nenum EventType {\n  LINK_OPENED = 'link_opened',\n  RSVP_STARTED = 'rsvp_started',\n  RSVP_SUBMITTED = 'rsvp_submitted',\n  RSVP_UPDATED = 'rsvp_updated',\n  GUEST_ADDED = 'guest_added',\n  PAYMENT_RECEIVED = 'payment_received',\n  REMINDER_SENT = 'reminder_sent'\n}\n\ninterface TrackingEvent {\n  id: string\n  family_id: string\n  wedding_id: string\n  event_type: EventType\n  channel?: Channel\n  metadata?: Record<string, any>\n  admin_triggered: boolean\n  timestamp: Date\n}\n\n// Create tracking event\nfunction trackEvent(event: Omit<TrackingEvent, 'id' | 'timestamp'>): Promise<void>\n\n// Query events with filters\ninterface EventFilter {\n  wedding_id: string\n  family_id?: string\n  event_type?: EventType[]\n  channel?: Channel\n  date_from?: Date\n  date_to?: Date\n}\n\nfunction getEvents(filter: EventFilter): Promise<TrackingEvent[]>\n```\n\n**Dependencies**: Prisma\n\n**Reuses**: Database client\n\n### 4. Excel Service (`lib/excel/`)\n\n**Purpose**: Import guest lists from Excel and export data to Excel/CSV\n\n**Modules**:\n- `import.ts`: Parse Excel, validate data, bulk insert families\n- `export.ts`: Generate Excel files from database data\n- `templates.ts`: Create downloadable Excel templates\n\n**Interfaces**:\n```typescript\ninterface ExcelRow {\n  family_name: string\n  contact_person: string\n  email?: string\n  phone?: string\n  whatsapp?: string\n  language?: Language\n  members: {\n    name: string\n    type: 'adult' | 'child' | 'infant'\n    age?: number\n  }[]\n}\n\ninterface ImportResult {\n  success: boolean\n  families_imported: number\n  errors: { row: number; message: string }[]\n  warnings: { row: number; message: string }[]\n}\n\n// Import guest list\nfunction importGuestList(\n  wedding_id: string,\n  file: Buffer\n): Promise<ImportResult>\n\n// Export guest data\nfunction exportGuestData(\n  wedding_id: string,\n  format: 'xlsx' | 'csv'\n): Promise<Buffer>\n\n// Generate template\nfunction generateTemplate(): Promise<Buffer>\n```\n\n**Dependencies**: xlsx, Prisma\n\n**Reuses**: Database client, Magic link generation\n\n### 5. Email Service (`lib/email/`)\n\n**Purpose**: Send transactional emails in multiple languages\n\n**Modules**:\n- `resend.ts`: Resend API client wrapper\n- `templates/`: Email template functions with i18n support\n\n**Interfaces**:\n```typescript\nenum EmailTemplate {\n  PLANNER_INVITATION = 'planner_invitation',\n  ADMIN_INVITATION = 'admin_invitation',\n  RSVP_REMINDER = 'rsvp_reminder',\n  RSVP_CONFIRMATION = 'rsvp_confirmation',\n  PAYMENT_CONFIRMATION = 'payment_confirmation'\n}\n\ninterface EmailOptions {\n  to: string\n  template: EmailTemplate\n  language: Language\n  variables: Record<string, string>\n}\n\n// Send email\nfunction sendEmail(options: EmailOptions): Promise<void>\n\n// Bulk send (e.g., reminders)\nfunction sendBulkEmail(emails: EmailOptions[]): Promise<void>\n```\n\n**Dependencies**: Resend, next-intl\n\n**Reuses**: i18n utilities\n\n### 6. Theme Service (`lib/theme/`)\n\n**Purpose**: Render custom themes on guest-facing pages\n\n**Modules**:\n- `engine.ts`: Theme CSS generation from JSONB config\n- `presets.ts`: 5 pre-built themes (Classic, Garden, Modern, Rustic, Beach)\n\n**Interfaces**:\n```typescript\ninterface ThemeConfig {\n  colors: {\n    primary: string\n    secondary: string\n    accent: string\n    background: string\n    text: string\n  }\n  fonts: {\n    heading: string\n    body: string\n  }\n  styles: {\n    buttonRadius: string\n    cardShadow: string\n    spacing: string\n  }\n  images?: {\n    logo?: string\n    banner?: string\n    background?: string\n  }\n}\n\ninterface Theme {\n  id: string\n  planner_id: string\n  name: string\n  description: string\n  config: ThemeConfig\n  is_system_theme: boolean\n}\n\n// Get theme for wedding\nfunction getWeddingTheme(wedding_id: string): Promise<Theme>\n\n// Generate CSS from theme config\nfunction generateThemeCSS(theme: Theme): string\n\n// Get all available themes for planner\nfunction getPlannerThemes(planner_id: string): Promise<Theme[]>\n```\n\n**Dependencies**: Prisma\n\n**Reuses**: Database client\n\n### 7. Payment Service (`lib/payment/`)\n\n**Purpose**: Integrate with GoCardless for automated payment matching (optional)\n\n**Modules**:\n- `gocardless.ts`: GoCardless Bank Account Data API client\n- `matching.ts`: Match transactions to families by reference code\n\n**Interfaces**:\n```typescript\ninterface BankTransaction {\n  id: string\n  amount: number\n  reference: string\n  transaction_date: Date\n  sender_name: string\n}\n\ninterface PaymentMatch {\n  transaction: BankTransaction\n  family_id: string | null\n  confidence: 'high' | 'medium' | 'low' | 'unmatched'\n}\n\n// Poll GoCardless for new transactions\nfunction pollTransactions(\n  account_id: string,\n  since: Date\n): Promise<BankTransaction[]>\n\n// Match transactions to families\nfunction matchPayments(\n  wedding_id: string,\n  transactions: BankTransaction[]\n): Promise<PaymentMatch[]>\n\n// Manually assign payment\nfunction manualAssignPayment(\n  wedding_id: string,\n  family_id: string,\n  amount: number,\n  transaction_date: Date\n): Promise<void>\n```\n\n**Dependencies**: GoCardless SDK, Prisma\n\n**Reuses**: Database client, Tracking service\n\n### 8. Internationalization Service (`lib/i18n/`)\n\n**Purpose**: Provide translations for all UI elements and communications\n\n**Modules**:\n- `config.ts`: Supported languages, fallback logic\n- `server.ts`: Server-side translation utilities\n- `client.ts`: Client-side translation hooks\n\n**Interfaces**:\n```typescript\ntype Language = 'es' | 'en' | 'fr' | 'it' | 'de'\n\n// Get translation\nfunction t(key: string, language: Language, variables?: Record<string, string>): string\n\n// Detect language\nfunction detectLanguage(\n  userPreference?: Language,\n  browserLanguage?: string,\n  weddingDefault?: Language\n): Language\n\n// Get all translations for a language\nfunction getTranslations(language: Language): Promise<Record<string, string>>\n```\n\n**Dependencies**: next-intl\n\n## Data Models\n\nAll models are defined in Prisma schema. Key relationships:\n\n### Core Tables\n\n#### Master Admin\n```prisma\nmodel MasterAdmin {\n  id                  String    @id @default(uuid())\n  email               String    @unique\n  name                String\n  preferred_language  Language  @default(EN)\n  created_at          DateTime  @default(now())\n}\n```\n\n#### Wedding Planner\n```prisma\nmodel WeddingPlanner {\n  id                  String    @id @default(uuid())\n  email               String    @unique\n  name                String\n  google_id           String?   @unique\n  auth_provider       AuthProvider\n  last_login_provider AuthProvider?\n  preferred_language  Language  @default(EN)\n  logo_url            String?\n  enabled             Boolean   @default(true)\n  subscription_status SubscriptionStatus @default(ACTIVE)\n  created_at          DateTime  @default(now())\n  created_by          String\n  last_login_at       DateTime?\n\n  weddings            Wedding[]\n  themes              Theme[]\n}\n```\n\n#### Theme\n```prisma\nmodel Theme {\n  id                      String   @id @default(uuid())\n  planner_id              String?\n  name                    String\n  description             String\n  is_default              Boolean  @default(false)\n  is_system_theme         Boolean  @default(false)\n  config                  Json     // ThemeConfig\n  preview_image_url       String?\n  created_at              DateTime @default(now())\n  updated_at              DateTime @updatedAt\n\n  planner                 WeddingPlanner? @relation(fields: [planner_id], references: [id])\n  weddings                Wedding[]\n\n  @@index([planner_id])\n}\n```\n\n#### Wedding\n```prisma\nmodel Wedding {\n  id                      String    @id @default(uuid())\n  planner_id              String\n  theme_id                String?\n  couple_names            String\n  wedding_date            DateTime\n  wedding_time            String\n  location                String\n  rsvp_cutoff_date        DateTime\n  dress_code              String?\n  additional_info         String?\n  payment_tracking_mode   PaymentMode @default(MANUAL)\n  allow_guest_additions   Boolean   @default(true)\n  default_language        Language  @default(ES)\n  status                  WeddingStatus @default(ACTIVE)\n  created_at              DateTime  @default(now())\n  created_by              String\n  updated_at              DateTime  @updatedAt\n  updated_by              String?\n\n  planner                 WeddingPlanner @relation(fields: [planner_id], references: [id])\n  theme                   Theme? @relation(fields: [theme_id], references: [id])\n  wedding_admins          WeddingAdmin[]\n  families                Family[]\n  tracking_events         TrackingEvent[]\n  notifications           Notification[]\n\n  @@index([planner_id])\n  @@index([theme_id])\n}\n```\n\n#### Wedding Admin\n```prisma\nmodel WeddingAdmin {\n  id                  String    @id @default(uuid())\n  email               String\n  name                String\n  google_id           String?\n  auth_provider       AuthProvider\n  last_login_provider AuthProvider?\n  preferred_language  Language  @default(EN)\n  wedding_id          String\n  invited_by          String\n  invited_at          DateTime  @default(now())\n  accepted_at         DateTime?\n  last_login_at       DateTime?\n  created_at          DateTime  @default(now())\n\n  wedding             Wedding @relation(fields: [wedding_id], references: [id], onDelete: Cascade)\n\n  @@unique([email, wedding_id])\n  @@index([wedding_id])\n}\n```\n\n#### Family\n```prisma\nmodel Family {\n  id                  String    @id @default(uuid())\n  wedding_id          String\n  name                String\n  email               String?\n  phone               String?\n  whatsapp_number     String?\n  magic_token         String    @unique @default(uuid())\n  reference_code      String?   @unique\n  channel_preference  Channel?\n  preferred_language  Language  @default(ES)\n  created_at          DateTime  @default(now())\n\n  wedding             Wedding @relation(fields: [wedding_id], references: [id], onDelete: Cascade)\n  members             FamilyMember[]\n  tracking_events     TrackingEvent[]\n  gifts               Gift[]\n  notifications       Notification[]\n\n  @@index([wedding_id])\n  @@index([magic_token])\n  @@index([reference_code])\n}\n```\n\n#### Family Member\n```prisma\nmodel FamilyMember {\n  id                      String    @id @default(uuid())\n  family_id               String\n  name                    String\n  type                    MemberType\n  attending               Boolean?\n  age                     Int?\n  dietary_restrictions    String?\n  accessibility_needs     String?\n  added_by_guest          Boolean   @default(false)\n  created_at              DateTime  @default(now())\n\n  family                  Family @relation(fields: [family_id], references: [id], onDelete: Cascade)\n\n  @@index([family_id])\n}\n```\n\n#### Tracking Event\n```prisma\nmodel TrackingEvent {\n  id                  String    @id @default(uuid())\n  family_id           String\n  wedding_id          String\n  event_type          EventType\n  channel             Channel?\n  metadata            Json?\n  admin_triggered     Boolean   @default(false)\n  timestamp           DateTime  @default(now())\n\n  family              Family @relation(fields: [family_id], references: [id], onDelete: Cascade)\n  wedding             Wedding @relation(fields: [wedding_id], references: [id], onDelete: Cascade)\n\n  @@index([family_id])\n  @@index([wedding_id])\n  @@index([event_type])\n  @@index([timestamp])\n}\n```\n\n#### Gift\n```prisma\nmodel Gift {\n  id                      String    @id @default(uuid())\n  family_id               String\n  wedding_id              String\n  amount                  Decimal\n  reference_code_used     String?\n  auto_matched            Boolean   @default(false)\n  status                  GiftStatus @default(PENDING)\n  transaction_date        DateTime\n  created_at              DateTime  @default(now())\n\n  family                  Family @relation(fields: [family_id], references: [id], onDelete: Cascade)\n\n  @@index([family_id])\n  @@index([wedding_id])\n}\n```\n\n#### Notification\n```prisma\nmodel Notification {\n  id                  String    @id @default(uuid())\n  wedding_id          String\n  family_id           String?\n  event_type          EventType\n  channel             Channel?\n  details             Json\n  read                Boolean   @default(false)\n  read_at             DateTime?\n  admin_id            String\n  created_at          DateTime  @default(now())\n\n  wedding             Wedding @relation(fields: [wedding_id], references: [id], onDelete: Cascade)\n  family              Family? @relation(fields: [family_id], references: [id], onDelete: Cascade)\n\n  @@index([wedding_id])\n  @@index([admin_id])\n  @@index([read])\n}\n```\n\n#### Translation\n```prisma\nmodel Translation {\n  id          String    @id @default(uuid())\n  key         String\n  language    Language\n  value       String\n  context     TranslationContext\n  updated_at  DateTime  @updatedAt\n\n  @@unique([key, language])\n  @@index([context])\n}\n```\n\n### Enums\n\n```prisma\nenum Language {\n  ES\n  EN\n  FR\n  IT\n  DE\n}\n\nenum AuthProvider {\n  GOOGLE\n  FACEBOOK\n  INSTAGRAM\n  APPLE\n  MICROSOFT\n}\n\nenum PaymentMode {\n  AUTOMATED\n  MANUAL\n}\n\nenum WeddingStatus {\n  ACTIVE\n  ARCHIVED\n  COMPLETED\n}\n\nenum MemberType {\n  ADULT\n  CHILD\n  INFANT\n}\n\nenum EventType {\n  LINK_OPENED\n  RSVP_STARTED\n  RSVP_SUBMITTED\n  RSVP_UPDATED\n  GUEST_ADDED\n  PAYMENT_RECEIVED\n  REMINDER_SENT\n}\n\nenum Channel {\n  WHATSAPP\n  EMAIL\n  SMS\n}\n\nenum GiftStatus {\n  PENDING\n  RECEIVED\n  CONFIRMED\n}\n\nenum TranslationContext {\n  ADMIN\n  GUEST\n  PLANNER\n}\n\nenum SubscriptionStatus {\n  ACTIVE\n  INACTIVE\n}\n```\n\n## API Architecture\n\n### API Route Structure\n\nAll APIs follow RESTful conventions with consistent response formats.\n\n#### Master Admin APIs (`/api/master/`)\n\n```\nGET    /api/master/planners              # List all planners\nPOST   /api/master/planners              # Create planner\nPATCH  /api/master/planners/:id          # Update planner (enable/disable)\nGET    /api/master/weddings              # List all weddings (read-only)\nGET    /api/master/analytics             # Platform analytics\n```\n\n#### Planner APIs (`/api/planner/`)\n\n```\nGET    /api/planner/weddings             # List planner's weddings\nPOST   /api/planner/weddings             # Create wedding\nGET    /api/planner/weddings/:id         # Get wedding details\nPATCH  /api/planner/weddings/:id         # Update wedding\nPOST   /api/planner/weddings/:id/admins  # Invite wedding admin\nDELETE /api/planner/weddings/:id/admins/:admin_id # Remove admin\n\nGET    /api/planner/themes               # List themes\nPOST   /api/planner/themes               # Create theme\nPATCH  /api/planner/themes/:id           # Update theme\nDELETE /api/planner/themes/:id           # Delete theme (if unused)\n\nGET    /api/planner/stats                # Dashboard stats\n```\n\n#### Wedding Admin APIs (`/api/admin/`)\n\n```\nGET    /api/admin/wedding                # Get wedding details\nPATCH  /api/admin/wedding                # Update wedding config\n\nPOST   /api/admin/guests/import          # Import Excel guest list\nGET    /api/admin/guests/export          # Export guest data\nGET    /api/admin/guests/template        # Download Excel template\nGET    /api/admin/guests                 # List all families\nPATCH  /api/admin/guests/:id             # Update family\n\nGET    /api/admin/notifications          # Get filtered notifications\nPATCH  /api/admin/notifications/:id/read # Mark notification as read\nPOST   /api/admin/notifications/export   # Export filtered notifications\n\nPOST   /api/admin/reminders              # Send manual reminders\nGET    /api/admin/reminders/preview      # Preview reminder recipients\n\nGET    /api/admin/payments               # List all payments\nPOST   /api/admin/payments               # Manually record payment\nPATCH  /api/admin/payments/:id           # Update payment status\n\nGET    /api/admin/guest-additions        # List guest-added members\nPATCH  /api/admin/guest-additions/:id    # Approve/edit guest addition\n\nPOST   /api/admin/admins                 # Invite additional admin\nDELETE /api/admin/admins/:id             # Remove admin\n```\n\n#### Guest APIs (`/api/guest/`)\n\n```\nGET    /api/guest/:token                 # Get family RSVP page data\nPOST   /api/guest/:token/rsvp            # Submit/update RSVP\nPOST   /api/guest/:token/member          # Add family member (if allowed)\nPATCH  /api/guest/:token/language        # Update language preference\nGET    /api/guest/:token/payment         # Get payment information\n```\n\n### Authentication Flows\n\n#### OAuth Flow (Admins)\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant NextAuth\n    participant OAuth\n    participant DB\n\n    User->>NextAuth: Click \"Sign in with Google\"\n    NextAuth->>OAuth: Redirect to Google OAuth\n    OAuth->>User: Login consent\n    User->>OAuth: Approve\n    OAuth->>NextAuth: Return with code\n    NextAuth->>OAuth: Exchange code for token\n    OAuth->>NextAuth: Return user profile\n    NextAuth->>DB: Check user exists & has access\n    DB->>NextAuth: User record\n    NextAuth->>DB: Update last_login_provider, last_login_at\n    NextAuth->>User: Set session cookie\n    User->>NextAuth: Access protected page\n```\n\n#### Magic Link Flow (Guests)\n\n```mermaid\nsequenceDiagram\n    participant Guest\n    participant WhatsApp\n    participant App\n    participant DB\n\n    Guest->>WhatsApp: Click magic link\n    WhatsApp->>App: GET /rsvp/{token}?channel=whatsapp\n    App->>DB: Validate token\n    DB->>App: Return family data\n    App->>DB: Track event: link_opened\n    App->>Guest: Display RSVP page\n    Guest->>App: Submit RSVP\n    App->>DB: Save RSVP data\n    App->>DB: Track event: rsvp_submitted\n    App->>Guest: Show confirmation + payment info\n```\n\n### Response Format\n\nAll API responses follow this structure:\n\n```typescript\ninterface APIResponse<T> {\n  success: boolean\n  data?: T\n  error?: {\n    code: string\n    message: string\n    details?: any\n  }\n  meta?: {\n    page?: number\n    limit?: number\n    total?: number\n  }\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n#### 1. Magic Token Invalid or Expired\n- **Handling**: Return 404 with message \"Link not found or expired\"\n- **User Impact**: Guest sees friendly error page with contact information\n- **Recovery**: Wedding admin can regenerate and resend link\n\n#### 2. RSVP Submission After Cutoff Date\n- **Handling**: Return 403 with message about cutoff enforcement\n- **User Impact**: Guest sees read-only RSVP with \"contact us\" message\n- **Recovery**: Guest contacts couple directly, admin manually updates\n\n#### 3. Excel Import Validation Failures\n- **Handling**: Return detailed error report with row numbers and issues\n- **User Impact**: Admin sees error summary before any data is imported\n- **Recovery**: Admin fixes Excel file and re-uploads\n\n#### 4. OAuth Authentication Failure\n- **Handling**: Return to login page with error message\n- **User Impact**: User sees \"Authentication failed, please try again\"\n- **Recovery**: User tries different provider or contacts support\n\n#### 5. Multi-Tenancy Violation (Access to Wrong Wedding)\n- **Handling**: Middleware intercepts, returns 403 Forbidden\n- **User Impact**: Admin sees \"Access denied\" message\n- **Recovery**: User must be invited to the wedding by planner\n\n#### 6. Payment Matching Ambiguity\n- **Handling**: Flag as \"requires manual review\" with suggestions\n- **User Impact**: Admin sees unmatched payments list with potential matches\n- **Recovery**: Admin manually assigns payment to correct family\n\n#### 7. Theme Deletion with Active Usage\n- **Handling**: Return 409 Conflict with count of weddings using theme\n- **User Impact**: Planner sees \"Cannot delete: used by X weddings\"\n- **Recovery**: Planner reassigns weddings to different theme first\n\n#### 8. Duplicate Email/Phone in Excel Import\n- **Handling**: Flag as warning but allow import with confirmation\n- **User Impact**: Admin sees warning summary and chooses to proceed or cancel\n- **Recovery**: Admin deduplicates or imports with duplicates knowingly\n\n### Error Logging Strategy\n\nAll errors logged with:\n- **Timestamp**: When error occurred\n- **User Context**: user_id, wedding_id, role\n- **Request Context**: Route, method, parameters\n- **Error Details**: Stack trace, error message\n- **Client Info**: User agent, IP (anonymized)\n\nLogging levels:\n- **ERROR**: System failures, database errors, integration failures\n- **WARN**: Validation failures, rate limiting, deprecation warnings\n- **INFO**: Successful operations, important state changes\n- **DEBUG**: Detailed flow information (development only)\n\n## Testing Strategy\n\n### Unit Testing\n\n**Tools**: Jest, React Testing Library\n\n**Coverage Targets**: 80% minimum\n\n**Focus Areas**:\n- **Utilities**: All functions in `lib/` (100% coverage)\n- **Components**: All reusable UI components\n- **Services**: Auth, tracking, email, Excel, payment, theme services\n- **Validation**: Form validation, Excel validation, token validation\n\n**Example Tests**:\n```typescript\n// lib/auth/magic-link.test.ts\ndescribe('generateMagicLink', () => {\n  it('should generate unique UUID v4 tokens', async () => {\n    const link1 = await generateMagicLink('family-1')\n    const link2 = await generateMagicLink('family-2')\n    expect(link1.token).not.toEqual(link2.token)\n    expect(link1.token).toMatch(/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/)\n  })\n})\n\n// lib/tracking/events.test.ts\ndescribe('trackEvent', () => {\n  it('should create event with correct wedding_id', async () => {\n    await trackEvent({\n      family_id: 'fam-1',\n      wedding_id: 'wed-1',\n      event_type: EventType.RSVP_SUBMITTED,\n      channel: Channel.WHATSAPP,\n      admin_triggered: false\n    })\n    const events = await getEvents({ wedding_id: 'wed-1' })\n    expect(events).toHaveLength(1)\n    expect(events[0].family_id).toBe('fam-1')\n  })\n})\n```\n\n### Integration Testing\n\n**Tools**: Jest with Prisma test client\n\n**Database Strategy**: Separate test database, reset between tests\n\n**Focus Areas**:\n- **API Routes**: All CRUD operations with authentication\n- **Multi-Tenancy**: Verify data isolation between weddings\n- **OAuth Flows**: Mock OAuth providers, test full authentication\n- **Excel Import/Export**: End-to-end file processing\n- **Payment Matching**: GoCardless webhook handling (mocked)\n\n**Example Tests**:\n```typescript\n// __tests__/integration/api/admin/guests.test.ts\ndescribe('POST /api/admin/guests/import', () => {\n  it('should import families and generate magic tokens', async () => {\n    const file = createTestExcelFile()\n    const response = await request(app)\n      .post('/api/admin/guests/import')\n      .set('Authorization', `Bearer ${weddingAdminToken}`)\n      .attach('file', file)\n\n    expect(response.status).toBe(200)\n    expect(response.body.data.families_imported).toBe(10)\n\n    const families = await prisma.family.findMany({ where: { wedding_id: 'test-wedding' }})\n    expect(families).toHaveLength(10)\n    families.forEach(f => expect(f.magic_token).toBeTruthy())\n  })\n})\n```\n\n### End-to-End Testing\n\n**Tools**: Playwright\n\n**Environments**: Staging environment with test data\n\n**Focus Areas**:\n- **Complete User Flows**: From login to RSVP submission\n- **Multi-Device**: Test on mobile, tablet, desktop\n- **Multi-Browser**: Chrome, Firefox, Safari, WhatsApp in-app browser\n- **Multi-Language**: Test all 5 languages\n- **Theme Rendering**: Verify custom themes apply correctly\n\n**Critical User Journeys**:\n1. **Master Admin Journey**:\n   - Sign in with OAuth\n   - Add new planner\n   - Disable planner\n   - View all weddings\n\n2. **Planner Journey**:\n   - Sign in with OAuth (test provider reminder)\n   - Create wedding with theme\n   - Invite wedding admin\n   - View wedding list\n\n3. **Wedding Admin Journey**:\n   - Accept invitation via email\n   - Import guest list from Excel\n   - View guest dashboard with filters\n   - Send manual reminders\n   - Record manual payment\n   - Export guest data\n\n4. **Guest Journey** (Most Critical):\n   - Click magic link from WhatsApp\n   - View RSVP page in Spanish\n   - Switch language to English\n   - Select attending members\n   - Add dietary restrictions\n   - Submit RSVP\n   - View payment information\n   - Return via link and edit RSVP\n   - Verify cutoff enforcement (read-only after date)\n\n**Example E2E Test**:\n```typescript\n// tests/e2e/guest-rsvp-flow.spec.ts\ntest('Guest can complete RSVP flow via magic link', async ({ page }) => {\n  // Generate magic link for test family\n  const magicLink = await generateTestMagicLink('test-family-id')\n\n  // Open link (simulating WhatsApp click)\n  await page.goto(`${magicLink}?channel=whatsapp`)\n\n  // Should see personalized welcome\n  await expect(page.locator('h1')).toContainText('Familia García')\n\n  // Select attending members\n  await page.check('[data-testid=\"member-1-attending\"]')\n  await page.check('[data-testid=\"member-2-attending\"]')\n\n  // Add dietary restriction\n  await page.fill('[data-testid=\"member-1-dietary\"]', 'Vegetarian')\n\n  // Submit RSVP\n  await page.click('[data-testid=\"submit-rsvp\"]')\n\n  // Should see confirmation and payment info\n  await expect(page.locator('[data-testid=\"confirmation\"]')).toBeVisible()\n  await expect(page.locator('[data-testid=\"payment-info\"]')).toBeVisible()\n\n  // Verify tracking event was created\n  const events = await getTrackingEvents('test-family-id')\n  expect(events.some(e => e.event_type === 'rsvp_submitted')).toBe(true)\n  expect(events.some(e => e.channel === 'whatsapp')).toBe(true)\n})\n```\n\n### Performance Testing\n\n**Tools**: Apache JMeter, Lighthouse\n\n**Metrics**:\n- **Page Load**: < 2 seconds on 3G\n- **API Response**: < 500ms for 95th percentile\n- **Database Queries**: < 100ms for typical queries\n- **Excel Import**: < 10 seconds for 500 families\n- **Theme Rendering**: No visual jank, smooth transitions\n\n**Load Testing Scenarios**:\n- 100 concurrent guests accessing RSVP pages\n- 10 wedding admins importing guest lists simultaneously\n- 1000 tracking events per minute\n\n## Security Considerations\n\n### Authentication Security\n\n- **OAuth State Parameter**: Prevent CSRF attacks on OAuth callbacks\n- **Session Security**: HTTP-only, secure cookies with 7-day expiration\n- **Token Rotation**: Refresh tokens on each request\n- **Provider Verification**: Verify email domains match expected patterns\n\n### Magic Link Security\n\n- **Cryptographic Randomness**: Use crypto.randomUUID() for tokens\n- **No Predictable Patterns**: Never use sequential IDs or timestamps\n- **Single-Use Option**: Consider making links one-time use (future enhancement)\n- **Rate Limiting**: Limit link generation to prevent abuse\n\n### Multi-Tenancy Security\n\n- **Automatic Filtering**: Prisma middleware enforces wedding_id on all queries\n- **Context Validation**: Verify user has access before any operation\n- **Row-Level Security**: Consider PostgreSQL RLS for additional layer\n- **Audit Logging**: Log all cross-tenant access attempts\n\n### Input Validation\n\n- **Zod Schemas**: Validate all API inputs with Zod\n- **Excel Sanitization**: Strip formulas, validate data types\n- **SQL Injection Prevention**: Prisma parameterized queries only\n- **XSS Prevention**: Sanitize user input, use React's built-in escaping\n\n### Data Privacy\n\n- **GDPR Compliance**: Provide data export and deletion capabilities\n- **Email Encryption**: Store emails hashed for privacy (consider)\n- **PII Minimization**: Only collect necessary guest information\n- **Anonymized Analytics**: Remove PII from tracking events for analytics\n\n## Deployment Architecture\n\n### Infrastructure\n\n- **Hosting**: Hetzner VPS (CPX41: 8 vCPUs, 16GB RAM, 240GB SSD)\n- **OS**: Ubuntu 22.04 LTS\n- **Reverse Proxy**: Nginx with SSL termination\n- **SSL**: Let's Encrypt with auto-renewal\n- **Domain**: Custom domain with DNS managed separately\n\n### Application Deployment\n\n- **Container**: Docker with docker-compose\n- **Process Manager**: PM2 for Node.js process management\n- **Database**: PostgreSQL 15 in separate container with persistent volumes\n- **Cache**: Redis in separate container (optional for MVP)\n\n### Docker Compose Structure\n\n```yaml\nversion: '3.8'\n\nservices:\n  app:\n    image: wedding-app:latest\n    container_name: wedding-app\n    restart: always\n    ports:\n      - \"3000:3000\"\n    environment:\n      - NODE_ENV=production\n      - DATABASE_URL=postgresql://user:pass@db:5432/wedding\n    depends_on:\n      - db\n    volumes:\n      - ./uploads:/app/uploads\n      - ./logs:/app/logs\n\n  db:\n    image: postgres:15\n    container_name: wedding-db\n    restart: always\n    environment:\n      - POSTGRES_USER=wedding\n      - POSTGRES_PASSWORD=${DB_PASSWORD}\n      - POSTGRES_DB=wedding\n    volumes:\n      - db-data:/var/lib/postgresql/data\n    ports:\n      - \"5432:5432\"\n\n  nginx:\n    image: nginx:alpine\n    container_name: wedding-nginx\n    restart: always\n    ports:\n      - \"80:80\"\n      - \"443:443\"\n    volumes:\n      - ./nginx.conf:/etc/nginx/nginx.conf\n      - ./ssl:/etc/nginx/ssl\n    depends_on:\n      - app\n\nvolumes:\n  db-data:\n```\n\n### CI/CD Pipeline\n\n1. **Code Push**: Developer pushes to `main` branch\n2. **GitHub Actions**: Run tests, lint, type-check\n3. **Build**: Create Docker image\n4. **Deploy**: SSH to VPS, pull new image, restart containers\n5. **Health Check**: Verify application is running\n6. **Rollback**: Automatic rollback if health check fails\n\n### Monitoring\n\n- **Application Logs**: Winston logger with daily rotation\n- **Database Monitoring**: pg_stat_statements for query analysis\n- **Uptime Monitoring**: UptimeRobot for external health checks\n- **Error Tracking**: Sentry for error reporting (optional)\n\n### Backup Strategy\n\n- **Database Backups**: Daily PostgreSQL dumps via cron\n- **Retention**: 30 days of daily backups\n- **Storage**: Backups stored on separate volume and remote backup service\n- **Recovery Testing**: Monthly restore test to verify backups\n\n## Future Enhancements (Post-MVP)\n\nThese features are documented in the PRD but deferred for later phases:\n\n1. **Seating Chart Management** (Phase 7)\n2. **Google Tasks Integration** (Phase 8)\n3. **Google Photos Integration** (Phase 9)\n4. **Spotify Playlist Integration** (Phase 10)\n5. **QR Code Check-in** (Phase 11)\n6. **Automated Thank-You Messages** (Phase 12)\n\nThese will require additional design documents when prioritized.\n",
  "fileStats": {
    "size": 41425,
    "lines": 1390,
    "lastModified": "2026-01-13T10:33:17.080Z"
  },
  "comments": []
}