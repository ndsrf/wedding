{
  "id": "snapshot_1769029241130_lu6cencu4",
  "approvalId": "approval_1769029241124_ng6m0zf3c",
  "approvalTitle": "Design Document - Wedding Checklist",
  "version": 1,
  "timestamp": "2026-01-21T21:00:41.130Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe Wedding Checklist feature introduces a comprehensive task management system that enables wedding planners to create reusable task templates and allows both planners and wedding admins to collaboratively manage wedding-specific checklists. The system automatically copies templates to new weddings, converts relative due dates to absolute dates, provides Excel import/export capabilities, sends notifications for task assignments and completions, and displays upcoming tasks on both admin and planner dashboards.\n\nThis feature integrates seamlessly with the existing multi-tenant architecture, leveraging established patterns for Excel processing, notifications, API routes, and database access. The design emphasizes modular code organization, reuse of existing utilities, and mobile-first user experience.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\nThe design follows all documented technical patterns:\n\n1. **Next.js 14+ with App Router**: API routes at `/api/planner/checklist-template/*` and `/api/admin/checklist/*` following existing route organization\n2. **PostgreSQL + Prisma ORM**: New models (ChecklistTemplate, ChecklistTask, ChecklistSection) with type-safe access\n3. **Mobile-First Design with Tailwind CSS**: Grid interface responsive with card layout on mobile, full grid on desktop\n4. **Multi-Tenancy via Prisma Middleware**: Automatic `wedding_id` filtering for checklist tasks, `planner_id` filtering for templates\n5. **Excel Integration**: Reuse existing `src/lib/excel/import.ts` and `export.ts` patterns\n6. **Notification System**: Leverage existing `Notification` model and notification creation patterns\n7. **TypeScript Strict Mode**: Full type safety with Zod validation schemas for API inputs\n\n### Project Structure (structure.md)\n\nThe implementation follows project organization conventions:\n\n**API Routes**:\n- `src/app/api/planner/checklist-template/route.ts` - Template CRUD\n- `src/app/api/planner/checklist-template/export/route.ts` - Template export\n- `src/app/api/planner/checklist-template/import/route.ts` - Template import\n- `src/app/api/admin/checklist/route.ts` - Checklist CRUD\n- `src/app/api/admin/checklist/export/route.ts` - Checklist export\n- `src/app/api/admin/checklist/import/route.ts` - Checklist import\n- `src/app/api/admin/upcoming-tasks/route.ts` - Admin upcoming tasks widget\n- `src/app/api/planner/upcoming-tasks/route.ts` - Planner upcoming tasks widget\n\n**UI Components**:\n- `src/components/planner/ChecklistTemplateEditor.tsx` - Template editor grid\n- `src/components/admin/ChecklistEditor.tsx` - Wedding checklist grid\n- `src/components/admin/UpcomingTasksWidget.tsx` - Admin dashboard widget\n- `src/components/planner/UpcomingTasksWidget.tsx` - Planner dashboard widget\n- `src/components/ui/TaskRow.tsx` - Shared task row component\n- `src/components/ui/RichTextEditor.tsx` - Rich text description editor\n- `src/components/ui/DatePicker.tsx` - Date picker with relative date support\n\n**Services**:\n- `src/lib/checklist/template.ts` - Template management service\n- `src/lib/checklist/crud.ts` - Checklist CRUD operations\n- `src/lib/checklist/date-converter.ts` - Relative to absolute date conversion\n- `src/lib/checklist/excel-import.ts` - Checklist Excel import\n- `src/lib/checklist/excel-export.ts` - Checklist Excel export\n- `src/lib/checklist/notifications.ts` - Task notification creation\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n1. **Excel Processing (`src/lib/excel/`)**\n   - **import.ts**: Reuse validation patterns, error handling, transaction logic\n   - **export.ts**: Reuse workbook creation, column width setting, buffer generation\n   - **templates.ts**: Extend to support checklist templates\n   - *How*: Create `src/lib/checklist/excel-import.ts` and `excel-export.ts` that follow the same patterns but with checklist-specific schemas\n\n2. **Notification System (`src/lib/notifications/`)**\n   - **invitation.ts**: Reuse notification creation patterns\n   - **Notification model**: Store task assignment/completion notifications\n   - *How*: Create `src/lib/checklist/notifications.ts` that creates notifications using the same `prisma.notification.create()` pattern with checklist-specific event types\n\n3. **UI Components (`src/components/ui/`)**\n   - **LanguageSwitcher.tsx**: Reference for dropdown patterns\n   - *How*: Create similar dropdown for \"Assigned To\" field, date pickers, and section selectors\n\n4. **Database Middleware (`src/lib/db/middleware.ts`)**\n   - **Multi-tenancy filtering**: Automatically enforces `wedding_id` on ChecklistTask queries\n   - *How*: Extend middleware to include new checklist models in tenant filtering\n\n5. **API Route Patterns (`src/app/api/`)**\n   - **admin/guests/route.ts**: Reference for CRUD operations with authentication\n   - **admin/guests/export/route.ts**: Reference for Excel export endpoints\n   - **admin/notifications/route.ts**: Reference for notification querying\n   - *How*: Follow identical authentication, validation, and error handling patterns\n\n### Integration Points\n\n1. **Wedding Creation Flow**\n   - **When**: New wedding is created in `src/app/api/planner/weddings/route.ts`\n   - **How**: Add hook to copy planner's template to new wedding checklist\n   - **Service**: `src/lib/checklist/template.ts#copyTemplateToWedding()`\n\n2. **Notification Feed**\n   - **Existing**: `src/app/api/admin/notifications/route.ts` queries notifications\n   - **How**: Add checklist event types to EventType enum, filter by task events\n   - **UI**: Notification feed already supports filtering by event type\n\n3. **Dashboard Widgets**\n   - **Admin Dashboard**: `/app/admin/page.tsx` - add `<UpcomingTasksWidget />` component\n   - **Planner Dashboard**: `/app/planner/page.tsx` - add `<UpcomingTasksWidget />` component\n   - **How**: Widgets fetch data from new API endpoints and display in existing dashboard layout\n\n4. **Database Schema**\n   - **Existing**: `prisma/schema.prisma` with Wedding, WeddingAdmin, WeddingPlanner models\n   - **How**: Add ChecklistTemplate, ChecklistSection, ChecklistTask models with proper relations and indexes\n\n5. **Multi-Language Support**\n   - **Existing**: `src/lib/i18n/` with translation infrastructure\n   - **How**: Add translations for task assignment dropdown values, widget headings, notification messages\n\n## Architecture\n\nThe checklist system follows a layered architecture with clear separation of concerns:\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                    Presentation Layer                        │\n│  (React Components - Template Editor, Checklist Editor)     │\n└──────────────────────┬──────────────────────────────────────┘\n                       │\n┌──────────────────────┴──────────────────────────────────────┐\n│                      API Layer                               │\n│  (Next.js API Routes - Authentication, Validation, Routing) │\n└──────────────────────┬──────────────────────────────────────┘\n                       │\n┌──────────────────────┴──────────────────────────────────────┐\n│                    Service Layer                             │\n│  (Business Logic - Template Copy, Date Conversion,          │\n│   Excel Processing, Notification Creation)                  │\n└──────────────────────┬──────────────────────────────────────┘\n                       │\n┌──────────────────────┴──────────────────────────────────────┐\n│                     Data Layer                               │\n│  (Prisma ORM - Database Access with Multi-Tenant Filtering) │\n└─────────────────────────────────────────────────────────────┘\n```\n\n### Modular Design Principles\n\n1. **Single File Responsibility**\n   - `template.ts`: Only handles template CRUD and copying\n   - `crud.ts`: Only handles checklist task CRUD\n   - `date-converter.ts`: Only handles date conversions\n   - `excel-import.ts`: Only handles Excel import logic\n   - `excel-export.ts`: Only handles Excel export logic\n   - `notifications.ts`: Only handles notification creation\n\n2. **Component Isolation**\n   - `TaskRow.tsx`: Single task row (40-60 lines)\n   - `ChecklistTemplateEditor.tsx`: Template editor layout (150-200 lines)\n   - `ChecklistEditor.tsx`: Reuses ChecklistTemplateEditor with slight modifications\n   - `RichTextEditor.tsx`: Standalone rich text component (100-150 lines)\n   - `UpcomingTasksWidget.tsx`: Standalone widget (80-120 lines)\n\n3. **Service Layer Separation**\n   - API routes only handle request/response, authentication, validation\n   - All business logic lives in `src/lib/checklist/` services\n   - Services are pure functions that can be tested independently\n\n4. **Utility Modularity**\n   - Date conversion: `convertRelativeDateToAbsolute(relativeDate, weddingDate)`\n   - Validation: Zod schemas for task, section, template structures\n   - Sanitization: HTML sanitizer for rich text descriptions\n\n### Architecture Diagram\n\n```mermaid\ngraph TB\n    subgraph \"Presentation Layer\"\n        PTE[Planner Template Editor]\n        WCE[Wedding Checklist Editor]\n        ATW[Admin Tasks Widget]\n        PTW[Planner Tasks Widget]\n    end\n\n    subgraph \"API Layer\"\n        TAPI[Template API Routes]\n        CAPI[Checklist API Routes]\n        UTAPI[Upcoming Tasks API]\n    end\n\n    subgraph \"Service Layer\"\n        TS[Template Service]\n        CS[Checklist CRUD Service]\n        DC[Date Converter]\n        EI[Excel Import Service]\n        EE[Excel Export Service]\n        NS[Notification Service]\n    end\n\n    subgraph \"Data Layer\"\n        DB[(PostgreSQL + Prisma)]\n        MW[Multi-Tenant Middleware]\n    end\n\n    PTE --> TAPI\n    WCE --> CAPI\n    ATW --> UTAPI\n    PTW --> UTAPI\n\n    TAPI --> TS\n    TAPI --> EI\n    TAPI --> EE\n    CAPI --> CS\n    CAPI --> EI\n    CAPI --> EE\n    UTAPI --> CS\n\n    TS --> DC\n    TS --> NS\n    CS --> NS\n    CS --> DC\n    EI --> CS\n    EE --> CS\n\n    TS --> MW\n    CS --> MW\n    MW --> DB\n```\n\n## Components and Interfaces\n\n### Component 1: Template Management Service\n\n**File**: `src/lib/checklist/template.ts`\n\n**Purpose**: Manage checklist templates for wedding planners (create, read, update, delete, copy to wedding)\n\n**Interfaces**:\n```typescript\nexport interface CreateTemplateData {\n  planner_id: string;\n  sections: Array<{\n    name: string;\n    order: number;\n    tasks: Array<{\n      title: string;\n      description: string | null;\n      assigned_to: 'WEDDING_PLANNER' | 'COUPLE' | 'OTHER';\n      due_date_relative: string | null; // e.g., \"WEDDING_DATE-90\" (90 days before)\n      order: number;\n    }>;\n  }>;\n}\n\nexport async function getTemplate(planner_id: string): Promise<ChecklistTemplate | null>\nexport async function saveTemplate(planner_id: string, data: CreateTemplateData): Promise<ChecklistTemplate>\nexport async function copyTemplateToWedding(planner_id: string, wedding_id: string): Promise<void>\nexport async function deleteTemplate(planner_id: string): Promise<void>\n```\n\n**Dependencies**:\n- Prisma client for database access\n- Date converter service for relative date handling\n- Validation schemas (Zod)\n\n**Reuses**:\n- Database transaction patterns from `src/lib/excel/import.ts`\n- Error handling patterns from existing services\n\n### Component 2: Checklist CRUD Service\n\n**File**: `src/lib/checklist/crud.ts`\n\n**Purpose**: Manage wedding-specific checklist tasks (create, read, update, delete, reorder)\n\n**Interfaces**:\n```typescript\nexport interface ChecklistTaskData {\n  wedding_id: string;\n  section_id: string | null;\n  title: string;\n  description: string | null;\n  assigned_to: 'WEDDING_PLANNER' | 'COUPLE' | 'OTHER';\n  due_date: Date | null;\n  status: 'PENDING' | 'IN_PROGRESS' | 'COMPLETED';\n  completed: boolean;\n  order: number;\n}\n\nexport async function getChecklist(wedding_id: string): Promise<ChecklistWithSections>\nexport async function createTask(data: ChecklistTaskData): Promise<ChecklistTask>\nexport async function updateTask(task_id: string, wedding_id: string, data: Partial<ChecklistTaskData>): Promise<ChecklistTask>\nexport async function deleteTask(task_id: string, wedding_id: string): Promise<void>\nexport async function reorderTasks(wedding_id: string, taskOrders: Array<{id: string, order: number}>): Promise<void>\nexport async function getUpcomingTasks(wedding_id: string, assigned_to: string, limit: number): Promise<ChecklistTask[]>\n```\n\n**Dependencies**:\n- Prisma client\n- Notification service for assignment/completion notifications\n- Multi-tenant middleware for automatic `wedding_id` filtering\n\n**Reuses**:\n- CRUD patterns from `src/lib/guests/crud.ts`\n- Query optimization patterns\n\n### Component 3: Date Converter Service\n\n**File**: `src/lib/checklist/date-converter.ts`\n\n**Purpose**: Convert relative dates (e.g., \"WEDDING_DATE-90\") to absolute dates based on wedding date\n\n**Interfaces**:\n```typescript\nexport type RelativeDateFormat =\n  | `WEDDING_DATE${'+' | '-'}${number}` // e.g., \"WEDDING_DATE-90\", \"WEDDING_DATE+7\"\n  | 'WEDDING_DATE';\n\nexport function parseRelativeDate(relativeDate: string): { offset: number } | null\nexport function convertRelativeDateToAbsolute(relativeDate: RelativeDateFormat, weddingDate: Date): Date\nexport function convertAbsoluteDateToRelative(absoluteDate: Date, weddingDate: Date): RelativeDateFormat\nexport function isValidRelativeDateFormat(value: string): boolean\n```\n\n**Dependencies**: None (pure utility functions)\n\n**Reuses**: Date formatting patterns from `src/lib/utils/date.ts`\n\n### Component 4: Excel Import Service\n\n**File**: `src/lib/checklist/excel-import.ts`\n\n**Purpose**: Import checklist tasks from Excel files with validation and preview\n\n**Interfaces**:\n```typescript\nexport interface ChecklistImportRow {\n  section: string;\n  title: string;\n  description: string | null;\n  assigned_to: 'WEDDING_PLANNER' | 'COUPLE' | 'OTHER';\n  due_date: string; // Can be relative or absolute\n  status: 'PENDING' | 'IN_PROGRESS' | 'COMPLETED';\n}\n\nexport interface ImportPreview {\n  newTasks: number;\n  updatedTasks: number;\n  sections: string[];\n  rows: ChecklistImportRow[];\n}\n\nexport interface ImportResult {\n  success: boolean;\n  tasksCreated: number;\n  tasksUpdated: number;\n  errors: ValidationError[];\n  warnings: ValidationWarning[];\n}\n\nexport async function parseChecklistExcel(buffer: Buffer): Promise<ChecklistImportRow[]>\nexport async function validateImportData(rows: ChecklistImportRow[], weddingDate: Date): Promise<{errors: ValidationError[], warnings: ValidationWarning[]}>\nexport async function previewImport(wedding_id: string, rows: ChecklistImportRow[]): Promise<ImportPreview>\nexport async function importChecklist(wedding_id: string, rows: ChecklistImportRow[], weddingDate: Date): Promise<ImportResult>\n```\n\n**Dependencies**:\n- xlsx library\n- Checklist CRUD service\n- Date converter service\n- Zod validation schemas\n\n**Reuses**:\n- Excel parsing logic from `src/lib/excel/import.ts`\n- Validation patterns and error structures\n\n### Component 5: Excel Export Service\n\n**File**: `src/lib/checklist/excel-export.ts`\n\n**Purpose**: Export checklist tasks to Excel files\n\n**Interfaces**:\n```typescript\nexport interface ExportOptions {\n  format?: 'xlsx' | 'csv';\n  includeCompleted?: boolean;\n  relativeDates?: boolean; // For template export\n}\n\nexport interface ExportResult {\n  buffer: Buffer;\n  filename: string;\n  mimeType: string;\n}\n\nexport async function exportChecklistTemplate(planner_id: string, options?: ExportOptions): Promise<ExportResult>\nexport async function exportWeddingChecklist(wedding_id: string, options?: ExportOptions): Promise<ExportResult>\nexport function generateChecklistExcelTemplate(): ExportResult\n```\n\n**Dependencies**:\n- xlsx library\n- Prisma client for data fetching\n\n**Reuses**:\n- Excel generation patterns from `src/lib/excel/export.ts`\n- Workbook creation and formatting\n\n### Component 6: Notification Service\n\n**File**: `src/lib/checklist/notifications.ts`\n\n**Purpose**: Create notifications for task assignments and completions\n\n**Interfaces**:\n```typescript\nexport interface TaskNotificationData {\n  wedding_id: string;\n  task_id: string;\n  task_title: string;\n  assigned_to: string;\n  event_type: 'TASK_ASSIGNED' | 'TASK_COMPLETED';\n  admin_id: string;\n  completed_by?: string;\n}\n\nexport async function createTaskAssignedNotification(data: TaskNotificationData): Promise<void>\nexport async function createTaskCompletedNotification(data: TaskNotificationData): Promise<void>\n```\n\n**Dependencies**:\n- Prisma client\n- Notification model\n\n**Reuses**:\n- Notification creation patterns from `src/lib/notifications/invitation.ts`\n\n### Component 7: Checklist Template Editor (UI)\n\n**File**: `src/components/planner/ChecklistTemplateEditor.tsx`\n\n**Purpose**: Grid interface for planners to edit task templates\n\n**Interfaces** (Props):\n```typescript\ninterface ChecklistTemplateEditorProps {\n  planner_id: string;\n  onSave: () => void;\n}\n```\n\n**Dependencies**:\n- TaskRow component\n- RichTextEditor component\n- DatePicker component\n- Fetch from `/api/planner/checklist-template`\n\n**Reuses**:\n- Table/grid patterns from existing admin components\n- Form handling patterns\n\n### Component 8: Wedding Checklist Editor (UI)\n\n**File**: `src/components/admin/ChecklistEditor.tsx`\n\n**Purpose**: Grid interface for planners and admins to edit wedding checklist\n\n**Interfaces** (Props):\n```typescript\ninterface ChecklistEditorProps {\n  wedding_id: string;\n  user_role: 'planner' | 'admin';\n}\n```\n\n**Dependencies**:\n- TaskRow component (shared with template editor)\n- RichTextEditor component\n- DatePicker component\n- Fetch from `/api/admin/checklist`\n\n**Reuses**:\n- Most layout and logic from ChecklistTemplateEditor\n- Different API endpoints and date handling (absolute vs. relative)\n\n### Component 9: Upcoming Tasks Widget (UI)\n\n**File**: `src/components/admin/UpcomingTasksWidget.tsx` and `src/components/planner/UpcomingTasksWidget.tsx`\n\n**Purpose**: Display upcoming tasks on dashboards with color-coded due dates\n\n**Interfaces** (Props):\n```typescript\n// Admin version\ninterface AdminUpcomingTasksWidgetProps {\n  wedding_id: string;\n}\n\n// Planner version\ninterface PlannerUpcomingTasksWidgetProps {\n  planner_id: string;\n}\n```\n\n**Dependencies**:\n- Fetch from `/api/admin/upcoming-tasks` or `/api/planner/upcoming-tasks`\n- Date utility functions for color coding\n\n**Reuses**:\n- Dashboard widget patterns from existing components\n\n### Component 10: Rich Text Editor (UI)\n\n**File**: `src/components/ui/RichTextEditor.tsx`\n\n**Purpose**: Inline rich text editor for task descriptions with URL support\n\n**Interfaces** (Props):\n```typescript\ninterface RichTextEditorProps {\n  value: string;\n  onChange: (value: string) => void;\n  placeholder?: string;\n  maxLength?: number;\n}\n```\n\n**Dependencies**:\n- DOMPurify for sanitization\n- Prosemirror or Tiptap library (or simple contenteditable with formatting buttons)\n\n**Reuses**:\n- Input component patterns from `src/components/ui/`\n\n## Data Models\n\n### Model 1: ChecklistTemplate\n\n```typescript\nmodel ChecklistTemplate {\n  id          String   @id @default(uuid())\n  planner_id  String   @unique // One template per planner\n  created_at  DateTime @default(now())\n  updated_at  DateTime @updatedAt\n\n  planner  WeddingPlanner        @relation(fields: [planner_id], references: [id], onDelete: Cascade)\n  sections ChecklistSection[]\n\n  @@index([planner_id])\n  @@map(\"checklist_templates\")\n}\n```\n\n**Purpose**: Stores the template created by each wedding planner (one-to-one relationship)\n\n### Model 2: ChecklistSection\n\n```typescript\nmodel ChecklistSection {\n  id          String   @id @default(uuid())\n  template_id String?  // Null if section belongs to wedding checklist\n  wedding_id  String?  // Null if section belongs to template\n  name        String\n  order       Int      @default(0)\n  created_at  DateTime @default(now())\n  updated_at  DateTime @updatedAt\n\n  template ChecklistTemplate? @relation(fields: [template_id], references: [id], onDelete: Cascade)\n  wedding  Wedding?            @relation(fields: [wedding_id], references: [id], onDelete: Cascade)\n  tasks    ChecklistTask[]\n\n  @@index([template_id])\n  @@index([wedding_id])\n  @@index([order])\n  @@map(\"checklist_sections\")\n}\n```\n\n**Purpose**: Organizes tasks into named sections (e.g., \"Initial Tasks\", \"Wedding Week Tasks\")\n\n**Design Decision**: Sections can belong to either a template OR a wedding checklist (not both). This allows flexible section management.\n\n### Model 3: ChecklistTask\n\n```typescript\nenum TaskAssignment {\n  WEDDING_PLANNER\n  COUPLE\n  OTHER\n}\n\nenum TaskStatus {\n  PENDING\n  IN_PROGRESS\n  COMPLETED\n}\n\nmodel ChecklistTask {\n  id                  String         @id @default(uuid())\n  section_id          String?        // Null if task not in a section\n  wedding_id          String?        // Null if task belongs to template\n  template_id         String?        // Null if task belongs to wedding\n  title               String\n  description         String?        @db.Text // Rich text content\n  assigned_to         TaskAssignment @default(COUPLE)\n  due_date            DateTime?      // Absolute date for wedding tasks\n  due_date_relative   String?        // Relative date for template tasks (e.g., \"WEDDING_DATE-90\")\n  status              TaskStatus     @default(PENDING)\n  completed           Boolean        @default(false)\n  completed_at        DateTime?\n  completed_by        String?        // User ID who completed the task\n  order               Int            @default(0)\n  created_at          DateTime       @default(now())\n  updated_at          DateTime       @updatedAt\n\n  section  ChecklistSection?  @relation(fields: [section_id], references: [id], onDelete: SetNull)\n  wedding  Wedding?           @relation(fields: [wedding_id], references: [id], onDelete: Cascade)\n  template ChecklistTemplate? @relation(fields: [template_id], references: [id], onDelete: Cascade)\n\n  @@index([section_id])\n  @@index([wedding_id])\n  @@index([template_id])\n  @@index([status])\n  @@index([assigned_to])\n  @@index([due_date])\n  @@index([completed])\n  @@index([order])\n  @@map(\"checklist_tasks\")\n}\n```\n\n**Purpose**: Represents a single task in a template or wedding checklist\n\n**Design Decisions**:\n- **completed** field separate from **status** for explicit checkbox state\n- **due_date_relative** for template tasks, **due_date** for wedding tasks\n- **completed_by** tracks who completed the task for notification purposes\n- **order** field enables drag-and-drop reordering\n\n### Model 4: EventType Enum Extension\n\n```typescript\nenum EventType {\n  // ... existing values\n  TASK_ASSIGNED\n  TASK_COMPLETED\n}\n```\n\n**Purpose**: Extend existing EventType enum to support checklist notifications\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Scenario: Template Not Found**\n   - **When**: Planner tries to edit template that doesn't exist\n   - **Handling**: Return 404 with message \"Template not found for this planner\"\n   - **User Impact**: Display empty template editor with \"Create your first template\" message\n\n2. **Scenario: Wedding Not Found or Access Denied**\n   - **When**: User tries to access checklist for wedding they don't have permission for\n   - **Handling**: API returns 403 Forbidden or 404 Not Found\n   - **User Impact**: Redirect to dashboard with error toast \"You don't have access to this wedding\"\n\n3. **Scenario: Excel Import Validation Failure**\n   - **When**: Uploaded Excel file has invalid data (missing required fields, invalid dates, etc.)\n   - **Handling**: Return 400 with detailed error list including row numbers and field names\n   - **User Impact**: Display validation errors in a list: \"Row 5: Title is required\", \"Row 12: Invalid date format\"\n\n4. **Scenario: Concurrent Task Edits**\n   - **When**: Planner and admin edit the same task simultaneously\n   - **Handling**: Last-write-wins with optimistic locking (check `updated_at` timestamp)\n   - **User Impact**: If conflict detected, show warning \"This task was recently modified. Your changes will overwrite the previous update.\"\n\n5. **Scenario: Excel File Too Large**\n   - **When**: User uploads Excel file > 10MB\n   - **Handling**: Reject upload before parsing, return 413 Payload Too Large\n   - **User Impact**: Display error \"File is too large. Maximum size is 10MB.\"\n\n6. **Scenario: Invalid Relative Date Format**\n   - **When**: Template contains invalid relative date string (e.g., \"WEDDING_DATE-ABC\")\n   - **Handling**: Validation error during save, return 400 with specific error\n   - **User Impact**: Display error \"Invalid due date format. Use format: WEDDING_DATE+30 or WEDDING_DATE-90\"\n\n7. **Scenario: Task Assignment Notification Failure**\n   - **When**: Notification creation fails due to database error\n   - **Handling**: Log error, but don't fail the task creation (notifications are non-critical)\n   - **User Impact**: Task is created successfully, notification may not appear (acceptable)\n\n8. **Scenario: XSS Attempt in Task Description**\n   - **When**: User enters malicious HTML/JS in task description\n   - **Handling**: Sanitize HTML using DOMPurify before rendering, strip scripts\n   - **User Impact**: Malicious content is removed, safe HTML is rendered\n\n## Testing Strategy\n\n### Unit Testing\n\n**Approach**: Test individual functions in isolation with mocked dependencies\n\n**Key Components to Test**:\n\n1. **Date Converter Service** (`date-converter.ts`)\n   - Test relative date parsing: \"WEDDING_DATE-90\" → 90 days offset\n   - Test absolute date conversion with various wedding dates\n   - Test edge cases: same day (\"WEDDING_DATE+0\"), far future dates\n   - Test invalid formats return null or throw expected errors\n\n2. **Excel Import Validation** (`excel-import.ts`)\n   - Test schema validation with valid and invalid data\n   - Test error message formatting (row numbers, field names)\n   - Test duplicate task detection\n   - Test date format parsing (YYYY-MM-DD, MM/DD/YYYY, relative)\n\n3. **Excel Export** (`excel-export.ts`)\n   - Test workbook generation with various task counts\n   - Test column width calculations\n   - Test filename generation with timestamp\n   - Test buffer creation and MIME type\n\n4. **Notification Creation** (`notifications.ts`)\n   - Test notification data structure for task assigned\n   - Test notification data structure for task completed\n   - Test error handling when notification creation fails\n\n5. **Template Copying** (`template.ts#copyTemplateToWedding`)\n   - Test sections are copied correctly\n   - Test relative dates are converted to absolute dates\n   - Test section order is preserved\n   - Test task order is preserved within sections\n\n**Test Framework**: Jest with @testing-library/react-hooks for service functions\n\n**Example Test**:\n```typescript\ndescribe('convertRelativeDateToAbsolute', () => {\n  it('converts WEDDING_DATE-90 to 90 days before wedding', () => {\n    const weddingDate = new Date('2026-06-15');\n    const result = convertRelativeDateToAbsolute('WEDDING_DATE-90', weddingDate);\n    expect(result).toEqual(new Date('2026-03-17'));\n  });\n\n  it('converts WEDDING_DATE+7 to 7 days after wedding', () => {\n    const weddingDate = new Date('2026-06-15');\n    const result = convertRelativeDateToAbsolute('WEDDING_DATE+7', weddingDate);\n    expect(result).toEqual(new Date('2026-06-22'));\n  });\n});\n```\n\n### Integration Testing\n\n**Approach**: Test API routes end-to-end with test database\n\n**Key Flows to Test**:\n\n1. **Template CRUD Flow**\n   - Create template → Verify in database\n   - Update template → Verify changes persisted\n   - Delete template → Verify soft delete or hard delete\n   - Get template → Verify correct data returned with proper structure\n\n2. **Template to Wedding Copy Flow**\n   - Create template with relative dates\n   - Create new wedding with specific date\n   - Verify checklist copied automatically (or trigger copy)\n   - Verify relative dates converted correctly\n   - Verify sections and tasks preserved\n\n3. **Checklist Task CRUD Flow**\n   - Create task → Verify in database with wedding_id\n   - Update task (change assigned_to) → Verify notification created\n   - Mark task completed → Verify completed_at set, notification created\n   - Delete task → Verify removed from database\n\n4. **Excel Import Flow**\n   - Upload valid Excel file → Verify tasks created\n   - Upload Excel with errors → Verify validation errors returned\n   - Upload Excel with updates → Verify existing tasks updated\n\n5. **Excel Export Flow**\n   - Export template → Verify Excel file generated with correct structure\n   - Export checklist → Verify Excel file contains all tasks with absolute dates\n\n6. **Upcoming Tasks Widget Flow**\n   - Query upcoming tasks for admin → Verify correct tasks returned, sorted by due date\n   - Query upcoming tasks for planner → Verify tasks from all weddings returned\n   - Verify color coding based on due dates\n\n**Test Framework**: Jest with supertest for API route testing\n\n**Example Test**:\n```typescript\ndescribe('POST /api/planner/checklist-template', () => {\n  it('creates template for authenticated planner', async () => {\n    const response = await request(app)\n      .post('/api/planner/checklist-template')\n      .set('Authorization', `Bearer ${plannerToken}`)\n      .send({\n        sections: [\n          {\n            name: 'Initial Tasks',\n            order: 0,\n            tasks: [\n              {\n                title: 'Book venue',\n                assigned_to: 'COUPLE',\n                due_date_relative: 'WEDDING_DATE-180',\n                order: 0\n              }\n            ]\n          }\n        ]\n      });\n\n    expect(response.status).toBe(200);\n    expect(response.body.success).toBe(true);\n\n    const template = await prisma.checklistTemplate.findUnique({\n      where: { planner_id: testPlannerId },\n      include: { sections: { include: { tasks: true } } }\n    });\n\n    expect(template).not.toBeNull();\n    expect(template.sections).toHaveLength(1);\n    expect(template.sections[0].tasks).toHaveLength(1);\n  });\n});\n```\n\n### End-to-End Testing\n\n**Approach**: Playwright tests simulating user interactions across browsers\n\n**User Scenarios to Test**:\n\n1. **Planner Creates Template**\n   - Navigate to template editor\n   - Add section \"Pre-Wedding Tasks\"\n   - Add task \"Book photographer\" assigned to couple, due \"WEDDING_DATE-120\"\n   - Save template\n   - Verify success message displayed\n\n2. **Planner Imports Template from Excel**\n   - Navigate to template editor\n   - Click \"Import from Excel\"\n   - Upload valid Excel file\n   - Review preview showing new tasks\n   - Confirm import\n   - Verify tasks appear in editor\n\n3. **Admin Edits Wedding Checklist**\n   - Navigate to wedding checklist\n   - Click task checkbox to mark complete\n   - Verify status updates to \"Completed\"\n   - Edit task description (add formatted text and URL)\n   - Verify changes saved\n\n4. **Admin Views Upcoming Tasks on Dashboard**\n   - Navigate to /admin dashboard\n   - Verify \"Assigned Tasks Coming Up Soon\" widget displays\n   - Verify tasks color-coded correctly (red, orange, green)\n   - Click task row\n   - Verify navigates to checklist screen\n\n5. **Planner Exports Wedding Checklist**\n   - Navigate to wedding checklist\n   - Click \"Export to Excel\"\n   - Verify Excel file downloads\n   - Open Excel file (manual verification or programmatic check)\n   - Verify columns and data correct\n\n6. **Mobile Responsive Experience**\n   - Open checklist on mobile viewport (375px width)\n   - Verify grid switches to card layout\n   - Verify touch targets ≥44px\n   - Verify drag-and-drop works on touch devices\n\n**Test Framework**: Playwright with cross-browser testing (Chrome, Firefox, Safari, WhatsApp in-app browser simulation)\n\n**Example Test**:\n```typescript\ntest('admin can mark task as complete', async ({ page }) => {\n  await page.goto('/admin/checklist');\n\n  // Find first pending task\n  const taskRow = page.locator('[data-testid=\"task-row\"]').first();\n  const checkbox = taskRow.locator('[data-testid=\"task-checkbox\"]');\n\n  // Mark as complete\n  await checkbox.click();\n\n  // Verify status updated\n  await expect(taskRow).toHaveAttribute('data-status', 'completed');\n\n  // Verify notification created (check notification badge)\n  const notificationBadge = page.locator('[data-testid=\"notification-badge\"]');\n  await expect(notificationBadge).toBeVisible();\n});\n```\n\n## Security Considerations\n\n### Multi-Tenancy Enforcement\n\n1. **Template Access**: Verify `planner_id` matches authenticated user before any template operation\n2. **Checklist Access**: Verify `wedding_id` belongs to authenticated user's weddings (via planner or admin relation)\n3. **API Routes**: All routes check authentication and authorization before data access\n4. **Prisma Middleware**: Extend existing middleware to filter ChecklistTask queries by `wedding_id`\n\n### Input Validation\n\n1. **Zod Schemas**: Define strict schemas for all API inputs (task creation, update, Excel import)\n2. **Date Validation**: Validate relative date formats match expected pattern, validate absolute dates are valid\n3. **Rich Text Sanitization**: Use DOMPurify to strip malicious HTML/JS from task descriptions\n4. **Excel Upload**: Validate file type is .xlsx, file size ≤10MB, strip macros and formulas\n\n### SQL Injection Prevention\n\n- **Prisma ORM**: All database queries use Prisma's parameterized queries (no raw SQL)\n- **Dynamic Filters**: Use Prisma's where clause builders, never string concatenation\n\n### XSS Prevention\n\n- **React Escaping**: Rely on React's built-in HTML escaping for all user-generated content\n- **Rich Text Rendering**: Use DOMPurify to sanitize HTML before rendering with `dangerouslySetInnerHTML`\n\n### CSRF Protection\n\n- **NextAuth.js**: OAuth flows already include CSRF protection\n- **SameSite Cookies**: Session cookies use SameSite=Lax or SameSite=Strict\n\n## Performance Optimizations\n\n### Database Query Optimization\n\n1. **Indexes**: Add indexes on frequently queried fields (wedding_id, planner_id, due_date, assigned_to, status)\n2. **Eager Loading**: Use Prisma's `include` to fetch sections and tasks in single query\n3. **Pagination**: Limit query results to 50 tasks per page for large checklists\n4. **Query Caching**: Consider Redis caching for templates (rarely change)\n\n### Excel Processing Optimization\n\n1. **Streaming**: For large files, use XLSX streaming API to avoid loading entire file in memory\n2. **Worker Threads**: Offload Excel parsing to worker threads for files >500 rows\n3. **Batch Inserts**: Use Prisma's `createMany` for bulk task creation during import\n\n### Frontend Performance\n\n1. **Code Splitting**: Lazy load ChecklistEditor component with `React.lazy()`\n2. **Virtualized Lists**: Use react-window for rendering >100 tasks without performance degradation\n3. **Debounced Saves**: Debounce inline edits by 500ms to reduce API calls\n4. **Optimistic Updates**: Update UI immediately, rollback on API failure\n\n### API Response Time\n\n- **Target**: <500ms for 95th percentile\n- **Monitoring**: Add performance logging for all checklist API routes\n- **Optimization**: If queries exceed 100ms, add indexes or denormalize data\n\n## Deployment Considerations\n\n### Database Migration\n\n```bash\n# Run Prisma migration to add new models\nnpx prisma migrate dev --name add_checklist_models\n\n# Generate Prisma client with new types\nnpx prisma generate\n```\n\n### Backward Compatibility\n\n- **Existing Weddings**: No checklist initially (null/empty)\n- **Migration Script**: Optionally run script to copy template to existing active weddings\n- **Feature Flag**: Consider feature flag to enable checklist per planner\n\n### Monitoring\n\n- **Error Tracking**: Log all checklist API errors to monitoring service (Sentry)\n- **Performance Metrics**: Track API response times for checklist endpoints\n- **Usage Metrics**: Track template creation, checklist edits, Excel imports/exports\n\n### Rollback Plan\n\n- **Database Schema**: Migrations are reversible with `prisma migrate resolve`\n- **Feature Toggle**: Disable checklist feature in UI if critical bugs found\n- **Data Preservation**: Do not delete checklist data on rollback, only hide UI\n",
  "fileStats": {
    "size": 36935,
    "lines": 980,
    "lastModified": "2026-01-21T21:00:35.389Z"
  },
  "comments": []
}