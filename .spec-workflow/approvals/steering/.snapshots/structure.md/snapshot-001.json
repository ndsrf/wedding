{
  "id": "snapshot_1768301847307_3hs1i0d2k",
  "approvalId": "approval_1768301847300_djhyncqky",
  "approvalTitle": "Structure Steering Document - Project Organization",
  "version": 1,
  "timestamp": "2026-01-13T10:57:27.307Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Project Structure\n\n## Directory Organization\n\n```\nwedding/\n├── src/                           # Application source code\n│   ├── app/                       # Next.js 14+ App Router\n│   │   ├── api/                   # API route handlers\n│   │   │   ├── auth/              # NextAuth.js authentication handlers\n│   │   │   │   └── [...nextauth]/ # Dynamic auth routes\n│   │   │   ├── master/            # Master admin API routes\n│   │   │   │   ├── planners/      # Planner CRUD operations\n│   │   │   │   ├── weddings/      # Read-only wedding overview\n│   │   │   │   └── analytics/     # Platform-wide analytics\n│   │   │   ├── planner/           # Wedding planner API routes\n│   │   │   │   ├── weddings/      # Wedding CRUD operations\n│   │   │   │   ├── themes/        # Theme management\n│   │   │   │   └── stats/         # Planner dashboard statistics\n│   │   │   ├── admin/             # Wedding admin API routes\n│   │   │   │   ├── wedding/       # Wedding configuration\n│   │   │   │   ├── guests/        # Guest list management\n│   │   │   │   ├── notifications/ # Activity notifications\n│   │   │   │   ├── reminders/     # Manual reminder system\n│   │   │   │   ├── payments/      # Payment tracking\n│   │   │   │   └── guest-additions/ # Guest-added member review\n│   │   │   └── guest/             # Guest RSVP API routes\n│   │   │       └── [token]/       # Magic link token-based routes\n│   │   ├── master/                # Master admin UI pages\n│   │   │   ├── page.tsx           # Dashboard\n│   │   │   ├── planners/          # Planner management pages\n│   │   │   └── layout.tsx         # Master admin layout\n│   │   ├── planner/               # Planner dashboard UI pages\n│   │   │   ├── page.tsx           # Wedding list dashboard\n│   │   │   ├── weddings/          # Wedding management pages\n│   │   │   ├── themes/            # Theme gallery and editor\n│   │   │   └── layout.tsx         # Planner layout\n│   │   ├── admin/                 # Wedding admin UI pages\n│   │   │   ├── page.tsx           # Guest dashboard\n│   │   │   ├── guests/            # Guest management pages\n│   │   │   ├── notifications/     # Activity feed\n│   │   │   ├── payments/          # Payment tracking pages\n│   │   │   └── layout.tsx         # Wedding admin layout\n│   │   ├── rsvp/                  # Guest-facing RSVP pages\n│   │   │   └── [token]/           # Magic link RSVP page\n│   │   │       ├── page.tsx       # Main RSVP form\n│   │   │       └── layout.tsx     # Guest layout with theme\n│   │   ├── layout.tsx             # Root layout (i18n provider, fonts)\n│   │   ├── globals.css            # Global Tailwind styles\n│   │   └── not-found.tsx          # 404 page\n│   ├── components/                # Reusable React components\n│   │   ├── ui/                    # Base UI components (shadcn/ui style)\n│   │   │   ├── button.tsx         # Button component\n│   │   │   ├── input.tsx          # Input component\n│   │   │   ├── card.tsx           # Card component\n│   │   │   ├── table.tsx          # Table component\n│   │   │   ├── dialog.tsx         # Modal dialog\n│   │   │   ├── dropdown.tsx       # Dropdown menu\n│   │   │   └── ...                # Other base components\n│   │   ├── master/                # Master admin-specific components\n│   │   │   ├── planner-list.tsx   # Planner table\n│   │   │   ├── planner-form.tsx   # Add/edit planner form\n│   │   │   └── wedding-overview.tsx # Read-only wedding list\n│   │   ├── planner/               # Planner-specific components\n│   │   │   ├── wedding-list.tsx   # Wedding dashboard table\n│   │   │   ├── wedding-form.tsx   # Create/edit wedding form\n│   │   │   ├── theme-gallery.tsx  # Theme selection gallery\n│   │   │   └── theme-editor.tsx   # Custom theme editor\n│   │   ├── admin/                 # Wedding admin-specific components\n│   │   │   ├── guest-table.tsx    # Guest list with filters\n│   │   │   ├── guest-form.tsx     # Add/edit guest\n│   │   │   ├── excel-import.tsx   # Excel upload component\n│   │   │   ├── notification-feed.tsx # Activity notification feed\n│   │   │   ├── reminder-dialog.tsx # Send reminders modal\n│   │   │   └── payment-tracker.tsx # Payment tracking table\n│   │   └── guest/                 # Guest RSVP components\n│   │       ├── rsvp-form.tsx      # Family RSVP form\n│   │       ├── member-selector.tsx # Family member checkboxes\n│   │       ├── language-switcher.tsx # Language dropdown\n│   │       └── payment-info.tsx   # Bank transfer details display\n│   ├── lib/                       # Shared utilities and services\n│   │   ├── db/                    # Database client and utilities\n│   │   │   ├── prisma.ts          # Prisma client singleton\n│   │   │   └── middleware.ts      # Multi-tenant filtering middleware\n│   │   ├── auth/                  # Authentication utilities\n│   │   │   ├── oauth.ts           # NextAuth.js configuration\n│   │   │   ├── magic-link.ts      # Magic link generation/validation\n│   │   │   ├── middleware.ts      # Auth middleware for route protection\n│   │   │   └── session.ts         # Session management helpers\n│   │   ├── i18n/                  # Internationalization\n│   │   │   ├── config.ts          # i18n configuration (supported languages)\n│   │   │   ├── server.ts          # Server-side translation utilities\n│   │   │   ├── client.ts          # Client-side translation hooks\n│   │   │   └── detect.ts          # Language detection logic\n│   │   ├── excel/                 # Excel import/export\n│   │   │   ├── import.ts          # Guest list import service\n│   │   │   ├── export.ts          # Data export service\n│   │   │   ├── validation.ts      # Excel data validation\n│   │   │   └── templates.ts       # Template generation\n│   │   ├── email/                 # Email service\n│   │   │   ├── resend.ts          # Resend API client wrapper\n│   │   │   └── templates/         # Email templates\n│   │   │       ├── planner-invitation.tsx  # Planner invite email\n│   │   │       ├── admin-invitation.tsx    # Admin invite email\n│   │   │       ├── rsvp-reminder.tsx       # RSVP reminder email\n│   │   │       └── payment-confirmation.tsx # Payment confirmed email\n│   │   ├── tracking/              # Event tracking\n│   │   │   ├── events.ts          # Tracking event service\n│   │   │   └── types.ts           # Event type definitions\n│   │   ├── payment/               # Payment integration\n│   │   │   ├── gocardless.ts      # GoCardless API client\n│   │   │   ├── matching.ts        # Payment matching logic\n│   │   │   └── manual.ts          # Manual payment recording\n│   │   ├── theme/                 # Theme system\n│   │   │   ├── engine.ts          # Theme CSS generation\n│   │   │   ├── presets.ts         # Pre-built themes\n│   │   │   └── types.ts           # Theme configuration types\n│   │   ├── utils/                 # General utilities\n│   │   │   ├── date.ts            # Date formatting helpers\n│   │   │   ├── validation.ts      # Zod validation schemas\n│   │   │   └── format.ts          # String/number formatting\n│   │   └── constants.ts           # Application-wide constants\n│   ├── types/                     # TypeScript type definitions\n│   │   ├── models.ts              # Database model types (generated by Prisma)\n│   │   ├── api.ts                 # API request/response types\n│   │   ├── theme.ts               # Theme configuration types\n│   │   └── index.ts               # Re-export all types\n│   └── middleware.ts              # Next.js middleware (auth, i18n routing)\n├── prisma/\n│   ├── schema.prisma              # Database schema definition\n│   ├── migrations/                # Database migration files\n│   │   └── [timestamp]_[name]/    # Individual migrations\n│   └── seed.ts                    # Database seeding script\n├── public/\n│   ├── locales/                   # Static translation files\n│   │   ├── es/                    # Spanish translations\n│   │   │   └── common.json\n│   │   ├── en/                    # English translations\n│   │   │   └── common.json\n│   │   ├── fr/                    # French translations\n│   │   │   └── common.json\n│   │   ├── it/                    # Italian translations\n│   │   │   └── common.json\n│   │   └── de/                    # German translations\n│   │       └── common.json\n│   └── images/                    # Static images (logos, icons)\n├── config/\n│   ├── master-admin.json          # Master admin email configuration\n│   └── themes.json                # System theme definitions\n├── tests/\n│   ├── unit/                      # Unit tests\n│   │   ├── lib/                   # Test lib utilities\n│   │   ├── components/            # Test components\n│   │   └── utils/                 # Test utilities\n│   ├── integration/               # Integration tests\n│   │   ├── api/                   # Test API routes\n│   │   └── db/                    # Test database operations\n│   └── e2e/                       # End-to-end tests (Playwright)\n│       ├── master-admin.spec.ts   # Master admin flows\n│       ├── planner.spec.ts        # Planner flows\n│       ├── wedding-admin.spec.ts  # Wedding admin flows\n│       └── guest-rsvp.spec.ts     # Guest RSVP flows\n├── .github/\n│   └── workflows/                 # GitHub Actions workflows\n│       ├── ci.yml                 # Continuous integration\n│       ├── release.yml            # Release automation\n│       └── deploy.yml             # Deployment automation\n├── docker/\n│   ├── Dockerfile                 # Multi-stage Docker build\n│   ├── docker-compose.yml         # Local development compose\n│   └── docker-compose.prod.yml    # Production compose template\n├── scripts/\n│   ├── setup.sh                   # Initial project setup\n│   ├── migrate.sh                 # Run database migrations\n│   └── deploy.sh                  # Deployment helper\n├── .env.example                   # Environment variables template\n├── .eslintrc.json                 # ESLint configuration\n├── .prettierrc                    # Prettier configuration\n├── commitlint.config.js           # Conventional commits enforcement\n├── tsconfig.json                  # TypeScript configuration\n├── next.config.js                 # Next.js configuration\n├── tailwind.config.ts             # Tailwind CSS configuration\n├── package.json                   # Dependencies and scripts\n├── package-lock.json              # Dependency lock file\n└── README.md                      # Project documentation\n```\n\n## Naming Conventions\n\n### Files\n\n- **Pages/Routes**: `kebab-case` for directories, `page.tsx` for route files (Next.js App Router convention)\n  - Example: `src/app/planner/weddings/page.tsx`\n- **React Components**: `PascalCase.tsx` for component files\n  - Example: `WeddingList.tsx`, `GuestTable.tsx`, `RsvpForm.tsx`\n- **Services/Utilities**: `kebab-case.ts` for non-component TypeScript files\n  - Example: `magic-link.ts`, `tracking-events.ts`, `date-utils.ts`\n- **API Routes**: `route.ts` for API route handlers (Next.js App Router convention)\n  - Example: `src/app/api/planner/weddings/route.ts`\n- **Tests**: `[filename].test.ts` or `[filename].spec.ts`\n  - Example: `magic-link.test.ts`, `guest-rsvp.spec.ts`\n- **Type Definitions**: `[domain].ts` in `src/types/` directory\n  - Example: `models.ts`, `api.ts`, `theme.ts`\n\n### Code\n\n- **React Components**: `PascalCase` for component names\n  - Example: `WeddingList`, `GuestTable`, `RsvpForm`\n- **Functions/Methods**: `camelCase` for function and method names\n  - Example: `generateMagicLink()`, `trackEvent()`, `validateToken()`\n- **Constants**: `UPPER_SNAKE_CASE` for global constants\n  - Example: `MAX_FAMILIES_PER_IMPORT`, `DEFAULT_LANGUAGE`, `API_VERSION`\n- **Variables**: `camelCase` for local variables and parameters\n  - Example: `weddingId`, `familyName`, `guestList`\n- **Types/Interfaces**: `PascalCase` for TypeScript types and interfaces\n  - Example: `Wedding`, `Family`, `TrackingEvent`, `ApiResponse<T>`\n- **Enums**: `PascalCase` for enum names, `UPPER_SNAKE_CASE` for enum values\n  - Example: `EventType.RSVP_SUBMITTED`, `Language.ES`, `Channel.WHATSAPP`\n\n### Database\n\n- **Table Names**: `snake_case` plural (Prisma convention)\n  - Example: `wedding_planners`, `families`, `family_members`, `tracking_events`\n- **Column Names**: `snake_case`\n  - Example: `wedding_id`, `magic_token`, `preferred_language`, `created_at`\n- **Enum Values**: `UPPER_CASE` in Prisma schema\n  - Example: `ADULT`, `CHILD`, `INFANT`, `WHATSAPP`, `EMAIL`, `SMS`\n\n## Import Patterns\n\n### Import Order\n\nAll files follow this strict import order (enforced by ESLint):\n\n1. **External dependencies** (React, Next.js, third-party libraries)\n2. **Internal absolute imports** (from `@/` alias)\n3. **Relative imports** (from `./` or `../`)\n4. **Type imports** (TypeScript types with `import type`)\n5. **Style imports** (CSS/SCSS files)\n\nExample:\n```typescript\n// 1. External dependencies\nimport { NextRequest, NextResponse } from 'next/server'\nimport { z } from 'zod'\n\n// 2. Internal absolute imports\nimport { prisma } from '@/lib/db/prisma'\nimport { requireAuth } from '@/lib/auth/middleware'\nimport { trackEvent } from '@/lib/tracking/events'\n\n// 3. Relative imports\nimport { validateGuestData } from './validation'\n\n// 4. Type imports\nimport type { Wedding, Family } from '@/types/models'\nimport type { ApiResponse } from '@/types/api'\n\n// 5. Style imports (if needed)\nimport './styles.css'\n```\n\n### Module Organization\n\n- **Absolute imports**: Use `@/` alias for all imports from `src/` directory\n  - Example: `import { prisma } from '@/lib/db/prisma'`\n- **Relative imports**: Only use for files within the same module/directory\n  - Example: `import { helper } from './utils'`\n- **No circular dependencies**: Avoid circular imports between modules\n- **Barrel exports**: Use `index.ts` files to re-export from directories when appropriate\n  - Example: `src/types/index.ts` exports all types from individual files\n\n## Code Structure Patterns\n\n### API Route Organization\n\nAll API routes follow this structure:\n\n```typescript\n// 1. Imports\nimport { NextRequest, NextResponse } from 'next/server'\nimport { z } from 'zod'\nimport { prisma } from '@/lib/db/prisma'\nimport { requireAuth } from '@/lib/auth/middleware'\n\n// 2. Validation schemas (Zod)\nconst requestSchema = z.object({\n  name: z.string().min(1),\n  email: z.string().email()\n})\n\n// 3. Handler function\nexport async function POST(request: NextRequest) {\n  try {\n    // 3a. Authentication\n    const user = await requireAuth(request, 'wedding_admin')\n\n    // 3b. Request validation\n    const body = await request.json()\n    const validated = requestSchema.parse(body)\n\n    // 3c. Authorization (multi-tenancy check)\n    const wedding = await prisma.wedding.findFirst({\n      where: { id: validated.weddingId, planner_id: user.planner_id }\n    })\n    if (!wedding) return NextResponse.json({ error: 'Forbidden' }, { status: 403 })\n\n    // 3d. Business logic\n    const result = await performOperation(validated)\n\n    // 3e. Response\n    return NextResponse.json({ success: true, data: result })\n  } catch (error) {\n    // 3f. Error handling\n    if (error instanceof z.ZodError) {\n      return NextResponse.json({ error: error.issues }, { status: 400 })\n    }\n    console.error('API Error:', error)\n    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 })\n  }\n}\n\n// 4. Helper functions (if needed)\nasync function performOperation(data: any) {\n  // Implementation\n}\n```\n\n### React Component Organization\n\nAll React components follow this structure:\n\n```typescript\n// 1. Imports\n'use client' // Only if client component\nimport { useState } from 'react'\nimport { Button } from '@/components/ui/button'\nimport type { Wedding } from '@/types/models'\n\n// 2. Props interface\ninterface WeddingListProps {\n  weddings: Wedding[]\n  onSelect: (weddingId: string) => void\n}\n\n// 3. Component definition\nexport function WeddingList({ weddings, onSelect }: WeddingListProps) {\n  // 3a. State declarations\n  const [selectedId, setSelectedId] = useState<string | null>(null)\n\n  // 3b. Event handlers\n  const handleClick = (id: string) => {\n    setSelectedId(id)\n    onSelect(id)\n  }\n\n  // 3c. Render\n  return (\n    <div className=\"wedding-list\">\n      {weddings.map(wedding => (\n        <div key={wedding.id} onClick={() => handleClick(wedding.id)}>\n          {wedding.couple_names}\n        </div>\n      ))}\n    </div>\n  )\n}\n\n// 4. Helper components (if small and related)\nfunction WeddingCard({ wedding }: { wedding: Wedding }) {\n  return <div>{wedding.couple_names}</div>\n}\n```\n\n### Service/Utility Organization\n\nAll service files follow this structure:\n\n```typescript\n// 1. Imports\nimport { prisma } from '@/lib/db/prisma'\nimport type { Family, TrackingEvent } from '@/types/models'\n\n// 2. Type definitions\ninterface TrackEventParams {\n  family_id: string\n  wedding_id: string\n  event_type: EventType\n  channel?: Channel\n}\n\n// 3. Main exported functions (public API)\nexport async function trackEvent(params: TrackEventParams): Promise<void> {\n  // Implementation\n}\n\nexport async function getEvents(weddingId: string): Promise<TrackingEvent[]> {\n  // Implementation\n}\n\n// 4. Internal helper functions (not exported)\nasync function validateEventData(params: TrackEventParams): Promise<boolean> {\n  // Implementation\n}\n```\n\n## Code Organization Principles\n\n### Single Responsibility Principle\n\n- **One purpose per file**: Each file should have a single, well-defined purpose\n  - API routes handle one resource type (e.g., `/api/admin/guests/route.ts` only handles guest operations)\n  - Components render one UI concept (e.g., `GuestTable` displays guests, `GuestForm` edits guests)\n  - Services handle one domain (e.g., `tracking/events.ts` only handles event tracking)\n\n### Modularity\n\n- **Service layer separation**: Business logic lives in `src/lib/`, not in API routes or components\n- **Reusable utilities**: Common functions extracted to `src/lib/utils/`\n- **Component composition**: Build complex UIs from smaller, focused components\n- **Avoid duplication**: Extract shared logic into utilities or hooks\n\n### Testability\n\n- **Pure functions**: Prefer pure functions that are easy to test in isolation\n- **Dependency injection**: Pass dependencies as parameters rather than importing globally\n- **Mock-friendly**: Design services to be easily mocked in tests\n- **Separation of concerns**: Keep business logic separate from framework code\n\n### Consistency\n\n- **Follow established patterns**: New code should match existing code style\n- **Use project conventions**: Follow naming, structure, and organization patterns\n- **Enforce with tooling**: ESLint, Prettier, TypeScript strict mode\n\n## Module Boundaries\n\n### Core vs. Feature Modules\n\n- **Core modules** (`src/lib/`): Reusable services with no feature-specific logic\n  - Authentication, database, i18n, tracking, email, Excel, payment, theme\n  - Can be used by any feature\n  - Should not import from feature modules\n\n- **Feature modules** (`src/app/`, `src/components/`): Feature-specific implementations\n  - Master admin, planner, wedding admin, guest features\n  - Can import from core modules\n  - Should minimize cross-feature dependencies\n\n### Public API vs. Internal Implementation\n\n- **Public exports**: Functions exported from modules are considered public API\n- **Internal helpers**: Non-exported functions are implementation details\n- **Barrel exports**: Use `index.ts` to explicitly define public API surface\n- **Documentation**: All public functions must have JSDoc comments\n\n### Dependency Direction\n\nThe dependency flow must always go in one direction:\n\n```\nPages/Components → Services → Database/External APIs\n     ↓                ↓              ↓\n   UI Logic     Business Logic   Data Access\n```\n\n**Rules:**\n- Pages/Components can import Services\n- Services can import Database/Utilities\n- Database/Utilities cannot import Services or Pages\n- No circular dependencies allowed\n\n### Multi-Tenancy Boundaries\n\nAll database queries must respect wedding-level isolation:\n\n- **Automatic filtering**: Prisma middleware enforces `wedding_id` filtering\n- **Context validation**: API routes verify user has access to requested wedding\n- **Row-level security**: Consider PostgreSQL RLS as additional layer\n- **Audit logging**: Log all cross-tenant access attempts\n\n## Code Size Guidelines\n\n### File Size\n\n- **Maximum file size**: 300 lines of code (excluding imports, blank lines, comments)\n- **Components**: Prefer smaller components (50-150 lines)\n- **API routes**: Keep routes focused (100-200 lines max)\n- **Services**: Break large services into smaller modules (200-300 lines max)\n\n### Function/Method Size\n\n- **Maximum function size**: 50 lines of code\n- **Prefer smaller functions**: 10-20 lines for most functions\n- **Extract helpers**: If function exceeds 50 lines, extract helpers\n- **Single level of abstraction**: Each function should operate at one level of abstraction\n\n### Complexity Guidelines\n\n- **Cyclomatic complexity**: Maximum 10 per function\n- **Nesting depth**: Maximum 3 levels of nesting\n- **Function parameters**: Maximum 4 parameters (use objects for more)\n- **If/else chains**: Prefer early returns or switch statements over deep if/else chains\n\n## Documentation Standards\n\n### Code Documentation\n\n- **All public APIs**: Must have JSDoc comments with description, params, returns, examples\n- **Complex logic**: Inline comments explaining \"why\" not \"what\"\n- **Type definitions**: Document non-obvious types with JSDoc\n- **README files**: Each major module should have a README explaining its purpose\n\n### JSDoc Format\n\n```typescript\n/**\n * Generate a magic link for guest family access.\n *\n * Creates a cryptographically secure UUID token that remains valid\n * until the wedding date. Tokens are wedding-scoped for security.\n *\n * @param familyId - The UUID of the family to generate a link for\n * @param weddingId - The UUID of the wedding for multi-tenancy scoping\n * @returns Promise resolving to the generated magic link object\n * @throws {Error} If family or wedding not found\n *\n * @example\n * const link = await generateMagicLink('fam-123', 'wed-456')\n * console.log(link.token) // \"a1b2c3d4-...\"\n */\nexport async function generateMagicLink(\n  familyId: string,\n  weddingId: string\n): Promise<MagicLink> {\n  // Implementation\n}\n```\n\n### Component Documentation\n\n```typescript\n/**\n * Guest table component with filtering and sorting.\n *\n * Displays a paginated list of guest families with real-time RSVP status,\n * attendance counts, and payment tracking. Supports filtering by status,\n * channel, and search across family names.\n *\n * @component\n * @example\n * <GuestTable\n *   weddingId=\"wed-123\"\n *   onSelectFamily={(id) => console.log(id)}\n * />\n */\nexport function GuestTable({ weddingId, onSelectFamily }: GuestTableProps) {\n  // Implementation\n}\n```\n\n## Additional Conventions\n\n### Environment Variables\n\n- **Naming**: `UPPER_SNAKE_CASE` for all environment variables\n- **Prefix**: Public variables use `NEXT_PUBLIC_` prefix\n- **Documentation**: Document all variables in `.env.example`\n- **Validation**: Validate required variables at application startup\n\n### Error Handling\n\n- **API errors**: Return consistent JSON error responses\n- **Client errors**: Display user-friendly error messages\n- **Logging**: Log errors with context (user_id, wedding_id, timestamp)\n- **Error boundaries**: Use React error boundaries for component errors\n\n### Performance\n\n- **Code splitting**: Use dynamic imports for large components\n- **Lazy loading**: Lazy load images and heavy components\n- **Memoization**: Use React.memo, useMemo, useCallback appropriately\n- **Database queries**: Always use pagination for list views (50 items per page)\n\n### Security\n\n- **Input validation**: Validate all user input with Zod schemas\n- **SQL injection**: Only use Prisma parameterized queries\n- **XSS prevention**: Use React's built-in escaping, sanitize user HTML\n- **CSRF protection**: NextAuth.js handles CSRF for OAuth flows\n- **Rate limiting**: Implement rate limiting on API routes (future enhancement)\n",
  "fileStats": {
    "size": 25839,
    "lines": 592,
    "lastModified": "2026-01-13T10:57:20.340Z"
  },
  "comments": []
}